
<!DOCTYPE html>
<html
  lang="en"
  data-figures=""
  
    class="page"
  
  
  >
  <head>
<title>【hadoop代码笔记】hadoop作业提交之TaskTracker获取Task | 爱豆吧！</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">





  
<meta property="og:locale" content="en" />

<meta property="og:type" content="article">
<meta name="description" content="一、概要描述
在上上一篇博文和上一篇博文中 分别描述了jobTracker和其服务（功能）模块初始化完成后，接收JobClient提交的作业，并进行初始化。本文着重描 述，JobTracker如何选择作业的Task分发到TaskTracker。本文只是描述一个TaskTracker如何从JobTracker …" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="">
<meta name="twitter:title" content="【hadoop代码笔记】hadoop作业提交之TaskTracker获取Task" />
<meta name="twitter:image" content="https://idouba.com/images/thumbnail.png"/>
<meta property="og:url" content="https://idouba.com/hadoop_mapreduce_tasktracker_retrieve_task/" />
<meta property="og:title" content="【hadoop代码笔记】hadoop作业提交之TaskTracker获取Task" />
<meta property="og:description" content="一、概要描述
在上上一篇博文和上一篇博文中 分别描述了jobTracker和其服务（功能）模块初始化完成后，接收JobClient提交的作业，并进行初始化。本文着重描 述，JobTracker如何选择作业的Task分发到TaskTracker。本文只是描述一个TaskTracker如何从JobTracker …" />
<meta property="og:image" content="https://idouba.com/images/thumbnail.png" />

<link rel="apple-touch-icon" sizes="180x180" href="https://idouba.com/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://idouba.com/icons/favicon-32x32.png">
<link rel="manifest" href="https://idouba.com/icons/site.webmanifest">

<link rel="canonical" href="https://idouba.com/hadoop_mapreduce_tasktracker_retrieve_task/">



<link rel="preload" href="https://idouba.com/css/styles.42e2c5f6d8cf9c52872666f8d8b2678ad0c426978b9d78aff3c33b7a1e7f6f97f54bcdaf0518a25fb0fe26367d04f8b07c683b3b38b331cb098daadee06b1f3e.css" integrity = "sha512-QuLF9tjPnFKHJmb42LJnitDEJpeLnXiv88M7eh5/b5f1S82vBRiiX7D&#43;JjZ9BPiwfGg7OzizMcsJjare4GsfPg==" as="style" crossorigin="anonymous">



<link rel="preload" href="https://idouba.com/en/js/bundle.ff336aa3aa59d3b9ad38479bb59153d96581fbb501e8946475e657e5412e6b0ecfd0011520c158ce613db24190d23242c59813c62c23f9d902b693489bbdf52f.js" as="script" integrity=
"sha512-/zNqo6pZ07mtOEebtZFT2WWB&#43;7UB6JRkdeZX5UEuaw7P0AEVIMFYzmE9skGQ0jJCxZgTxiwj&#43;dkCtpNIm731Lw==" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="https://idouba.com/css/styles.42e2c5f6d8cf9c52872666f8d8b2678ad0c426978b9d78aff3c33b7a1e7f6f97f54bcdaf0518a25fb0fe26367d04f8b07c683b3b38b331cb098daadee06b1f3e.css" integrity="sha512-QuLF9tjPnFKHJmb42LJnitDEJpeLnXiv88M7eh5/b5f1S82vBRiiX7D&#43;JjZ9BPiwfGg7OzizMcsJjare4GsfPg==" crossorigin="anonymous">

  </head>
  <body
    data-code="7"
    data-lines="false"
    id="documentTop"
    data-lang="en"
  >

<header class="nav_header" >
  <nav class="nav"><a href='https://idouba.com/' class="nav_brand nav_item" title="爱豆吧！">爱豆吧！
  <div class="nav_close">
    <div><svg class="icon">
  <title>open-menu</title>
  <use xlink:href="#open-menu"></use>
</svg>
<svg class="icon">
  <title>closeme</title>
  <use xlink:href="#closeme"></use>
</svg>
</div>
  </div>
</a>

    <div class='nav_body nav_body_left'>
      
      
      
        

  <div class="nav_parent">
    <a href="https://idouba.com/" class="nav_item" title="Home">Home </a>
  </div>
  <div class="nav_parent">
    <a href="https://idouba.com/post/rich-content/" class="nav_item" title="Archives">Archives </a>
  </div>
  <div class="nav_parent">
    <a href="https://idouba.com/about/" class="nav_item" title="About">About </a>
  </div>
      
      <div class="nav_parent">
        <a href="#" class="nav_item">🌐</a>
        <div class="nav_sub">
          <span class="nav_child"></span>
          
          <a href="https://idouba.com/" class="nav_child nav_item">English</a>
          
          <a href="https://idouba.com/pt/" class="nav_child nav_item">Português</a>
          
        </div>
      </div>
<div class='follow'>
<div class="color_mode">
  <input type="checkbox" class="color_choice" id="mode">
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class="grid-inverse wrap content">
  <article class="post_content">
    <h1 class="post_title">【hadoop代码笔记】hadoop作业提交之TaskTracker获取Task</h1>
  <div class="post_meta">
    <span><svg class="icon">
  <title>calendar</title>
  <use xlink:href="#calendar"></use>
</svg>
</span>
    <span class="post_date">
      Jan 18, 2014</span>
    <span class="post_time"> · 13 min read</span><span>&nbsp;· <a href='https://idouba.com/tags/hadoop/' title="hadoop" class="post_tag button button_translucent">hadoop
        </a><a href='https://idouba.com/tags/java/' title="java" class="post_tag button button_translucent">java
        </a><a href='https://idouba.com/tags/mapreduce/' title="mapreduce" class="post_tag button button_translucent">mapreduce
        </a><a href='https://idouba.com/tags/source/' title="source" class="post_tag button button_translucent">source
        </a>
    </span>
    <span class="page_only">&nbsp;·
  <div class="post_share">
    Share on:
    <a href="https://twitter.com/intent/tweet?text=%e3%80%90hadoop%e4%bb%a3%e7%a0%81%e7%ac%94%e8%ae%b0%e3%80%91hadoop%e4%bd%9c%e4%b8%9a%e6%8f%90%e4%ba%a4%e4%b9%8bTaskTracker%e8%8e%b7%e5%8f%96Task&url=https%3a%2f%2fidouba.com%2fhadoop_mapreduce_tasktracker_retrieve_task%2f&tw_p=tweetbutton" class="twitter" title="Share on Twitter" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>twitter</title>
  <use xlink:href="#twitter"></use>
</svg>

    </a>
    <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fidouba.com%2fhadoop_mapreduce_tasktracker_retrieve_task%2f&t=%e3%80%90hadoop%e4%bb%a3%e7%a0%81%e7%ac%94%e8%ae%b0%e3%80%91hadoop%e4%bd%9c%e4%b8%9a%e6%8f%90%e4%ba%a4%e4%b9%8bTaskTracker%e8%8e%b7%e5%8f%96Task" class="facebook" title="Share on Facebook" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>facebook</title>
  <use xlink:href="#facebook"></use>
</svg>

    </a>
    <a href="#linkedinshare" id = "linkedinshare" class="linkedin" title="Share on LinkedIn" rel="nofollow">
      <svg class="icon">
  <title>linkedin</title>
  <use xlink:href="#linkedin"></use>
</svg>

    </a>
    <a href="https://idouba.com/hadoop_mapreduce_tasktracker_retrieve_task/" title="Copy Link" class="link link_yank">
      <svg class="icon">
  <title>copy</title>
  <use xlink:href="#copy"></use>
</svg>

    </a>
  </div>
  </span>
  </div>

    <div class="post_body"><p><strong>一、概要描述</strong></p>
<p>在<a href="../hadoop_mapreduce_jobadded">上上一篇博文</a>和<a href="../hadoop_mapreduce_job_init">上一篇博文</a>中 分别描述了jobTracker和其服务（功能）模块初始化完成后，接收JobClient提交的作业，并进行初始化。本文着重描 述，JobTracker如何选择作业的Task分发到TaskTracker。本文只是描述一个TaskTracker如何从JobTracker获取 Task任务。Task任务在TaskTracker如何执行将在<a href="../hadoop_mapreduce_tasktracker_launch_task">后面博文</a>中描述。</p>
<p><strong>二、 流程描述</strong></p>
<ol>
<li>TaskTracker在run中调用offerService()方法一直死循环的去连接Jobtracker，先Jobtracker发送心跳，发送自身状态，并从Jobtracker获取任务指令来执行。</li>
<li>在JobTracker的heartbeat方法中，对于来自每一个TaskTracker的心跳请求，根据一定的作业调度策略调用assignTasks方法选择一定Task</li>
<li>Scheduler调用对应的LoadManager的canAssignMap方法和canAssignReduce方法以决定是否可以给 tasktracker分配任务。默认的是CapBasedLoad，全局平均分配。即根据全局的任务槽数，全局的map任务数的比值得到一个load系 数，该系数乘以待分配任务的tasktracker的最大map任务数，即是该tasktracker能分配得到的任务数。如果太tracker当前运行 的任务数小于可运行的任务数，则任务可以分配新作业给他。（图中缺失了LoadManager的表达，也画不下了，就不加了。在代码详细分析中有）</li>
<li>Scheduler的调用TaskSelector的obtainNewMapTask或者obtainNewReduceTask选择Task。</li>
<li>在DefaultTaskSelector中选择Task的方法其实只是封装了JobInProgress的对应方法。</li>
<li>JobTracker根据得到的Task构造TaskTrackerAction设置到到HeartbeatResponse返回给TaskTracker。</li>
<li>TaskTracker中将来自JobTracker的任务加入到TaskQueue中等待执行。</li>
</ol>
<p><figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="TaskTracker获取Task"
      
        class="image_figure image_internal image_unprocessed"
        src="../wp-content/uploads/2014/01/hadoop_mapreduce_tasktracker_retrieve_task.png"
      
      
    />

    </picture>
</figure>
</p>
<p><strong>三、代码详细</strong></p>
<p><strong>1. TaskTracker的入口函数main</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">JobConf</span><span class="w"> </span><span class="n">conf</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">JobConf</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">      </span><span class="c1">// enable the server to track time spent waiting on locks</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">      </span><span class="n">ReflectionUtils</span><span class="p">.</span><span class="na">setContentionTracing</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">        </span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="na">getBoolean</span><span class="p">(</span><span class="s">&#34;tasktracker.contention.tracking&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">TaskTracker</span><span class="p">(</span><span class="n">conf</span><span class="p">).</span><span class="na">run</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>TaskTracker的构造函数</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">maxCurrentMapTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conf</span><span class="p">.</span><span class="na">getInt</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">                  </span><span class="s">&#34;mapred.tasktracker.map.tasks.maximum&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">maxCurrentReduceTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conf</span><span class="p">.</span><span class="na">getInt</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">                  </span><span class="s">&#34;mapred.tasktracker.reduce.tasks.maximum&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="k">this</span><span class="p">.</span><span class="na">jobTrackAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JobTracker</span><span class="p">.</span><span class="na">getAddress</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">//启动httpserver 展示tasktracker状态。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="k">this</span><span class="p">.</span><span class="na">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpServer</span><span class="p">(</span><span class="s">&#34;task&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">httpBindAddress</span><span class="p">,</span><span class="w"> </span><span class="n">httpPort</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">httpPort</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">conf</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="n">server</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="k">this</span><span class="p">.</span><span class="na">httpPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">server</span><span class="p">.</span><span class="na">getPort</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">//初始化方法</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">initialize</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>TaskTracker的initialize方法，完成TaskTracker的初始化工作。</li>
</ol>
<p>主要流程</p>
<p>1)检查可以创建本地文件夹</p>
<p>2)清理或者初始化需要用到的实例集合变量</p>
<p>3)初始化RPC服务器，接受task的请求。</p>
<p>4)清除临时文件</p>
<p>5)jobtracker的代理，负责处理和jobtracker的交互，通过RPC方式。</p>
<p>6)一个线程，获取map完成事件。</p>
<p>7)初始化内存管理</p>
<p>8)分别启动map和reduce的tasklauncher</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">  </span><span class="c1">//检查可以创建本地文件夹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="n">checkLocalDirs</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">fConf</span><span class="p">.</span><span class="na">getLocalDirs</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="n">fConf</span><span class="p">.</span><span class="na">deleteLocalFiles</span><span class="p">(</span><span class="n">SUBDIR</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="c1">//清理或者初始化需要用到的实例集合变量</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="na">tasks</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">runningTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;</span><span class="n">TaskAttemptID</span><span class="p">,</span><span class="w"> </span><span class="n">TaskInProgress</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">runningJobs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeMap</span><span class="o">&lt;</span><span class="n">JobID</span><span class="p">,</span><span class="w"> </span><span class="n">RunningJob</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="na">jvmManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JvmManager</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="c1">//初始化RPC服务器，接受task的请求。</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">taskReportServer</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">RPC</span><span class="p">.</span><span class="na">getServer</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">bindAddress</span><span class="p">,</span><span class="w"> </span><span class="n">tmpPort</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">fConf</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">taskReportServer</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="c1">// 清除临时文件</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">      </span><span class="n">DistributedCache</span><span class="p">.</span><span class="na">purgeCache</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">fConf</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">     </span><span class="n">cleanupStorage</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="c1">//jobtracker的代理，负责处理和jobtracker的交互，通过RPC方式。</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="na">jobClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InterTrackerProtocol</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="n">RPC</span><span class="p">.</span><span class="na">waitForProxy</span><span class="p">(</span><span class="n">InterTrackerProtocol</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">                         </span><span class="n">InterTrackerProtocol</span><span class="p">.</span><span class="na">versionID</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">                         </span><span class="n">jobTrackAddr</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">fConf</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="c1">//一个线程，获取map完成事件。</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">mapEventsFetcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MapEventsFetcherThread</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">      </span><span class="n">mapEventsFetcher</span><span class="p">.</span><span class="na">setDaemon</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">      </span><span class="n">mapEventsFetcher</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">                               </span><span class="s">&#34;Map-events fetcher for all reduce tasks &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;on &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="n">taskTrackerName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">      </span><span class="n">mapEventsFetcher</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">  </span><span class="c1">//初始化内存管理</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">  </span><span class="n">initializeMemoryManagement</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">  </span><span class="c1">//分别启动map和reduce的tasklauncher</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">  </span><span class="n">mapLauncher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TaskLauncher</span><span class="p">(</span><span class="n">maxCurrentMapTasks</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">      </span><span class="n">reduceLauncher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TaskLauncher</span><span class="p">(</span><span class="n">maxCurrentReduceTasks</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">      </span><span class="n">mapLauncher</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">      </span><span class="n">reduceLauncher</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ol start="4">
<li><strong>TaskTracker</strong> <strong>的<strong><strong>run</strong></strong>方法，在其中一直尝试执行offerService方法</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">running</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">staleState</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">shuttingDown</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">denied</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="n">State</span><span class="w"> </span><span class="n">osState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offerService</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>5. TaskTracker 的offerService方法</strong></p>
<ol>
<li>
<p>通过RPC调用获得Jobtracker的系统目录。</p>
</li>
<li>
<p>发送心跳并且获取Jobtracker的应答</p>
</li>
<li>
<p>从JobTrackeer的应答中获取指令</p>
</li>
<li>
<p>不同的指令类型执行不同的动作</p>
</li>
<li>
<p>对于要launch的task加入到taskQueue中去</p>
</li>
<li>
<p>对于清理动作，加入待清理的task集合，会有线程自动清理</p>
</li>
<li>
<p>杀死那些过久未反馈进度的task</p>
</li>
<li>
<p>当磁盘空间不够时，杀死某些task以腾出空间</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">State</span><span class="w"> </span><span class="nf">offerService</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">        </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">        </span><span class="c1">//通过RPC调用获得Jobtracker的系统目录。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jobClient</span><span class="p">.</span><span class="na">getSystemDir</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IOException</span><span class="p">(</span><span class="s">&#34;Failed to get system directory&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">                  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">                  </span><span class="n">systemDirectory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">                  </span><span class="n">systemFS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">systemDirectory</span><span class="p">.</span><span class="na">getFileSystem</span><span class="p">(</span><span class="n">fConf</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="c1">// 发送心跳并且获取Jobtracker的应答</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">HeartbeatResponse</span><span class="w"> </span><span class="n">heartbeatResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transmitHeartBeat</span><span class="p">(</span><span class="n">now</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="c1">//从JobTrackeer的应答中获取指令</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">TaskTrackerAction</span><span class="o">[]</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heartbeatResponse</span><span class="p">.</span><span class="na">getActions</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="c1">//不同的指令类型执行不同的动作</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">actions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">                  </span><span class="k">for</span><span class="p">(</span><span class="n">TaskTrackerAction</span><span class="w"> </span><span class="n">action</span><span class="p">:</span><span class="w"> </span><span class="n">actions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="c1">//对于要launch的task加入到taskQueue中去</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">LaunchTaskAction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">addToTaskQueue</span><span class="p">((</span><span class="n">LaunchTaskAction</span><span class="p">)</span><span class="n">action</span><span class="p">);</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">CommitTaskAction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">                      </span><span class="n">CommitTaskAction</span><span class="w"> </span><span class="n">commitAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">CommitTaskAction</span><span class="p">)</span><span class="n">action</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">commitResponses</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">commitAction</span><span class="p">.</span><span class="na">getTaskID</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="n">commitResponses</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">commitAction</span><span class="p">.</span><span class="na">getTaskID</span><span class="p">());}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="c1">//加入待清理的task集合，会有线程自动清理</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="n">tasksToCleanup</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">action</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">                  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="c1">//杀死那些过久未反馈进度的task</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="n">markUnresponsiveTasks</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="c1">//当磁盘空间不够时，杀死某些task以腾出空间</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">         </span><span class="n">killOverflowingTasks</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>6. TaskTracker的 transmitHeartBeat方法，定时向JobTracker发心跳。其实是通过RPC的方式向调用Jobtracker的heartbeat方法。</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">HeartbeatResponse</span><span class="w"> </span><span class="nf">transmitHeartBeat</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">askForNewTask</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="kt">long</span><span class="w"> </span><span class="n">localMinSpaceStart</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">//判断该Tasktracker是否可以接受新的task，依赖于</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">      </span><span class="n">askForNewTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="na">countMapTasks</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxCurrentMapTasks</span><span class="w"> </span><span class="o">||</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">                       </span><span class="n">status</span><span class="p">.</span><span class="na">countReduceTasks</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxCurrentReduceTasks</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">                      </span><span class="n">acceptNewTasks</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span><span class="n">localMinSpaceStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minSpaceStart</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">askForNewTask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">      </span><span class="n">checkLocalDirs</span><span class="p">(</span><span class="n">fConf</span><span class="p">.</span><span class="na">getLocalDirs</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="c1">//判断本地空间是否足够，以决定是否接受新的task</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span><span class="n">askForNewTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enoughFreeSpace</span><span class="p">(</span><span class="n">localMinSpaceStart</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">freeDiskSpace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFreeSpace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">totVmem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTotalVirtualMemoryOnTT</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">totPmem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTotalPhysicalMemoryOnTT</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">      </span><span class="n">status</span><span class="p">.</span><span class="na">getResourceStatus</span><span class="p">().</span><span class="na">setAvailableSpace</span><span class="p">(</span><span class="n">freeDiskSpace</span><span class="p">);</span><span class="w"> </span><span class="n">status</span><span class="p">.</span><span class="na">getResourceStatus</span><span class="p">().</span><span class="na">setTotalVirtualMemory</span><span class="p">(</span><span class="n">totVmem</span><span class="p">);</span><span class="w"> </span><span class="n">status</span><span class="p">.</span><span class="na">getResourceStatus</span><span class="p">().</span><span class="na">setTotalPhysicalMemory</span><span class="p">(</span><span class="n">totPmem</span><span class="p">);</span><span class="w"> </span><span class="n">status</span><span class="p">.</span><span class="na">getResourceStatus</span><span class="p">().</span><span class="na">setMapSlotMemorySizeOnTT</span><span class="p">(</span><span class="n">mapSlotMemorySizeOnTT</span><span class="p">);</span><span class="w"> </span><span class="n">status</span><span class="p">.</span><span class="na">getResourceStatus</span><span class="p">().</span><span class="na">setReduceSlotMemorySizeOnTT</span><span class="p">(</span><span class="n">reduceSlotSizeMemoryOnTT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w"></span><span class="c1">//通过jobclient通过RPC的方式向调用Jobtracker的heartbeat方法。</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="n">HeartbeatResponse</span><span class="w"> </span><span class="n">heartbeatResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jobClient</span><span class="p">.</span><span class="na">heartbeat</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">ustStarted</span><span class="p">,</span><span class="n">justInited</span><span class="p">,</span><span class="w"> </span><span class="n">askForNewTask</span><span class="p">,</span><span class="w">                                                               </span><span class="n">heartbeatResponseId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>6. JobTracker的 heartbeat方法。Jobtracker 接受并处理 tasktracker上报的状态，在返回的应答信息中指示tasktracker完成启停job或启动某个task的动作。</strong></p>
<table>
<thead>
<tr>
<th><strong>动作类型类</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>CommitTaskAction</td>
<td>指示Task保存输出，即提交</td>
</tr>
<tr>
<td>KillJobAction</td>
<td>杀死属于这个Job的任何一个Task</td>
</tr>
<tr>
<td>KillTaskAction</td>
<td>杀死指定的Task</td>
</tr>
<tr>
<td>LaunchTaskAction</td>
<td>开启某个task</td>
</tr>
<tr>
<td>ReinitTrackerAction</td>
<td>重新初始化taskTracker</td>
</tr>
</tbody>
</table>
<p>主要流程如下：</p>
<ol>
<li>
<p>acceptTaskTracker(status)方法通过查询inHostsList(status) &amp;&amp; !inExcludedHostsList确认Tasktracker是否在JobTracker的允许列表中。</p>
</li>
<li>
<p>当得知TaskTracker重启的标记，从jobtracker的潜在故障名单中移除该tasktracker</p>
</li>
<li>
<p>如果initialContact为否表示这次心跳请求不是该taskTracker第一次连接jobtracker，但是如果在jobtracker的 trackerToHeartbeatResponseMap记录中没有之前的响应记录，则说明发生了笔记严重的错误。发送指令给tasktracker 要求其重新初始化。</p>
</li>
<li>
<p>如果这是有问题的tasktracker重新接回来的第一个心跳，则通知recoveryManager recoveryManager从的recoveredTrackers列表中移除该tracker以表示该tracker又正常的接回来了。</p>
</li>
<li>
<p>如果initialContact != true 并且 revHeartbeatResponse != null表示上一个心跳应答存在，但是tasktracker表示第一次请求，则说上一个initialContact请求的应答丢失了，未传送到 tasktracker。则只是简单的把原来的应答重发一下即可。</p>
</li>
<li>
<p>构造应答的Id，是递加的。</p>
</li>
<li>
<p>处理心跳，其实就是在jobTracker端更新该tasktracker的状态</p>
</li>
<li>
<p>检查tasktracker可以运行新的task</p>
</li>
<li>
<p>调用JobTracker配置的taskSceduler来调度task给对应的TaskTracker。从submit到JobTracker的Job列表中选择每个job的每个Task，适合交给该TaskTracker调度的Task</p>
</li>
<li>
<p>把分配的Task加入到expireLaunchingTasks，监视并处理其是否超时。</p>
</li>
<li>
<p>根据调度器发获得要启动的task构造LaunchTaskAction，通知taskTracker启动这些task。</p>
</li>
<li>
<p>把属于该tasktracker的，job已经结束的task加入到killTasksList，发送到tasktracker杀死。即结束那些在tasktracker上已经结束了的作业的task，不管作业是完成还失败。</p>
</li>
<li>
<p>判定哪些作业需要清理的，构造Action加入到action列表中。trackerToJobsToCleanup是一个结合，当job gc的时候，调用 finalizeJob进而调用 addJobForCleanup 把作业加入到trackerToJobsToCleanup中</p>
</li>
<li>
<p>判定那些task可以提交输出，构造action加入到action列表。</p>
</li>
<li>
<p>计算下一次心跳的间隔，设置到应答消息中。</p>
</li>
<li>
<p>把上面这些Action设置到response中返回。</p>
</li>
<li>
<p>把本次应答保存到trackerToHeartbeatResponseMap中</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">HeartbeatResponse</span><span class="w"> </span><span class="nf">heartbeat</span><span class="p">(</span><span class="n">TaskTrackerStatus</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w">               </span><span class="kt">boolean</span><span class="w"> </span><span class="n">restarted</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">               </span><span class="kt">boolean</span><span class="w"> </span><span class="n">initialContact</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">               </span><span class="kt">boolean</span><span class="w"> </span><span class="n">acceptNewTasks</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">               </span><span class="kt">short</span><span class="w"> </span><span class="n">responseId</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">   </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">   
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">   </span><span class="c1">//1) acceptTaskTracker(status)方法通过查询inHostsList(status) &amp;&amp; !inExcludedHostsList确认Tasktracker是否在JobTracker的允许列表中。</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">acceptTaskTracker</span><span class="p">(</span><span class="n">status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DisallowedTaskTrackerException</span><span class="p">(</span><span class="n">status</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">trackerName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">.</span><span class="na">getTrackerName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">  </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isBlacklisted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">restarted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">  </span><span class="c1">//2)当得知TaskTracker重启的标记，从jobtracker的潜在故障名单中移除该tasktracker</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">  </span><span class="n">faultyTrackers</span><span class="p">.</span><span class="na">markTrackerHealthy</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="na">getHost</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">  </span><span class="n">isBlacklisted</span><span class="w"> </span><span class="o">=</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">  </span><span class="n">faultyTrackers</span><span class="p">.</span><span class="na">shouldAssignTasksToTracker</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="na">getHost</span><span class="p">(),</span><span class="w"> </span><span class="n">now</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">  </span><span class="n">HeartbeatResponse</span><span class="w"> </span><span class="n">prevHeartbeatResponse</span><span class="w"> </span><span class="o">=</span><span class="n">trackerToHeartbeatResponseMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">trackerName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">  </span><span class="kt">boolean</span><span class="w"> </span><span class="n">addRestartInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initialContact</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">  </span><span class="c1">//3)如果initialContact为否表示这次心跳请求不是该taskTracker第一次连接jobtracker，但是如果在jobtracker的trackerToHeartbeatResponseMap记录中没有之前的响应记录，则说明发生了笔记严重的错误。发送指令给tasktracker要求其重新初始化。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prevHeartbeatResponse</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">  </span><span class="c1">// This is the first heartbeat from the old tracker to the newly </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">  </span><span class="c1">// started JobTracker</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">  </span><span class="c1">//4)如果这是有问题的tasktracker重新接回来的第一个心跳，则通知recoveryManager</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasRestarted</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">  </span><span class="n">addRestartInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">  </span><span class="c1">// recoveryManager从的recoveredTrackers列表中移除该tracker以表示该tracker又正常的接回来了。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">  </span><span class="n">recoveryManager</span><span class="p">.</span><span class="na">unMarkTracker</span><span class="p">(</span><span class="n">trackerName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">  </span><span class="c1">//发送指令让tasktracker重新初始化。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HeartbeatResponse</span><span class="p">(</span><span class="n">responseId</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">TaskTrackerAction</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="k">new</span><span class="w"> </span><span class="n">ReinitTrackerAction</span><span class="p">()});</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">  </span><span class="c1">//如果initialContact != true 并且 revHeartbeatResponse != null表示上一个心跳应答存在，但是tasktracker表示第一次请求，则说上一个initialContact请求的应答丢失了，未传送到tasktracker。则只是简单的把原来的应答重发一下即可。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prevHeartbeatResponse</span><span class="p">.</span><span class="na">getResponseId</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">responseId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">  </span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Ignoring &#39;duplicate&#39; heartbeat from &#39;&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">  </span><span class="n">trackerName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;&#39;; resending the previous &#39;lost&#39; response&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">prevHeartbeatResponse</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">  </span><span class="c1">// 应答的Id是递加的。 </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">  </span><span class="kt">short</span><span class="w"> </span><span class="n">newResponseId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">short</span><span class="p">)(</span><span class="n">responseId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">  </span><span class="n">status</span><span class="p">.</span><span class="na">setLastSeen</span><span class="p">(</span><span class="n">now</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">  </span><span class="c1">//处理心跳，其实就是在jobTracker端更新该tasktracker的状态</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">processHeartbeat</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">initialContact</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prevHeartbeatResponse</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">  </span><span class="n">trackerToHeartbeatResponseMap</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">trackerName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HeartbeatResponse</span><span class="p">(</span><span class="n">newResponseId</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">TaskTrackerAction</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="k">new</span><span class="w"> </span><span class="n">ReinitTrackerAction</span><span class="p">()});</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">  </span><span class="c1">// 检查tasktracker可以运行新的task</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">recoveryManager</span><span class="p">.</span><span class="na">shouldSchedule</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">acceptNewTasks</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isBlacklisted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">  </span><span class="n">TaskTrackerStatus</span><span class="w"> </span><span class="n">taskTrackerStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTaskTracker</span><span class="p">(</span><span class="n">trackerName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">taskTrackerStatus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSetupAndCleanupTasks</span><span class="p">(</span><span class="n">taskTrackerStatus</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tasks</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">  </span><span class="c1">//2调用JobTracker配置的taskSceduler来调度task给对应的TaskTracker。从submit到JobTracker的Job列表中选择每个job的每个Task，适合交给该TaskTracker调度的Task</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">  </span><span class="n">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskScheduler</span><span class="p">.</span><span class="na">assignTasks</span><span class="p">(</span><span class="n">taskTrackerStatus</span><span class="p">);}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tasks</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">  </span><span class="c1">//把分配的Task加入到expireLaunchingTasks，监视并处理其是否超时。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Task</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tasks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">  </span><span class="n">Object</span><span class="w"> </span><span class="n">expireLaunchingTasks</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">  </span><span class="n">expireLaunchingTasks</span><span class="p">.</span><span class="na">addNewTask</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="na">getTaskID</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">  </span><span class="n">actions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LaunchTaskAction</span><span class="p">(</span><span class="n">task</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">  </span><span class="c1">//把属于该tasktracker的，job已经结束的task加入到killTasksList，发送到tasktracker杀死。即结束那些在tasktracker上已经结束了的作业的task，不管作业是完成还失败。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TaskTrackerAction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">killTasksList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTasksToKill</span><span class="p">(</span><span class="n">trackerName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">killTasksList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">  </span><span class="n">actions</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">killTasksList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">  </span><span class="c1">//判定哪些作业需要清理。finalizeJob-&gt; addJobForCleanup 当gc一个job的时候，会调用以上方法把其加入到trackerToJobsToCleanup中</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TaskTrackerAction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">killJobsList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getJobsForCleanup</span><span class="p">(</span><span class="n">trackerName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">killJobsList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">  </span><span class="n">actions</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">killJobsList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">  </span><span class="c1">//判定那些task可以提交输出。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TaskTrackerAction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">commitTasksList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTasksToSave</span><span class="p">(</span><span class="n">status</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">commitTasksList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w"> </span><span class="n">actions</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">commitTasksList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w"> </span><span class="c1">//calculate next heartbeat interval and put in heartbeat response</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w"> </span><span class="c1">//计算下一次心跳的间隔，设置到应答消息中。</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nextInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNextHeartbeatInterval</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">setHeartbeatInterval</span><span class="p">(</span><span class="n">nextInterval</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w"> </span><span class="c1">//把上面这些Action设置到response中返回。</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">setActions</span><span class="p">(</span><span class="n">actions</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TaskTrackerAction</span><span class="o">[</span><span class="n">actions</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w"> </span><span class="c1">//把本次应答保存到trackerToHeartbeatResponseMap中</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w"> </span><span class="n">trackerToHeartbeatResponseMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">trackerName</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>7.FairScheduler的assignTasks方法。JobTracker就是调用该方法来实现作业的分配的。</strong></p>
<p>主要流程如下：</p>
<p>1)分别计算可运行的maptask和reducetask总数</p>
<p>2)ClusterStatus 维护了当前Map/Reduce作业框架的总体状况。根据ClusterStatus计算得到获得map task的槽数，reduce task的槽数。</p>
<p>3)调用LoadManager方法决定是否可以为该tasktracker分配任务(默认CapBasedLoadManager方法根据全局的任务槽数， 全局的map任务数的比值得到一个load系数，该系数乘以待分配任务的tasktracker的最大map任务数，即是该tasktracker能分配 得到的任务数。如果太tracker当前运行的任务数小于可运行的任务数，则任务可以分配新作业给他)</p>
<p>4)从job列表中找出那些job需要运行map或reduce任务，加到List<JobInProgress> candidates集合中</p>
<p>5)对candidates集合中的job排序，对每个job调用taskSelector的obtainNewMapTask或者 obtainNewReduceTask方法获取要执行的task。把所以的task放到task集合中返回。从而实现了作业Job的任务Task分配。</p>
<p>6)并对candidates集合中的每个job，更新Jobinfo信息，即其正在运行的task数，需要运行的task数，以便其后续调度用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">assignTasks</span><span class="p">(</span><span class="n">TaskTrackerStatus</span><span class="w"> </span><span class="n">tracker</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">             </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">initialized</span><span class="p">)</span><span class="w"> </span><span class="c1">// Don&#39;t try to assign tasks if we haven&#39;t yet started up</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">         </span><span class="n">oolMgr</span><span class="p">.</span><span class="na">reloadAllocsIfNecessary</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">         </span><span class="c1">// 分别计算可运行的maptask和reducetask总数</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">runnableMaps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">runnableReduces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">JobInProgress</span><span class="w"> </span><span class="n">job</span><span class="p">:</span><span class="w"> </span><span class="n">infos</span><span class="p">.</span><span class="na">keySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">             </span><span class="n">runnableMaps</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">runnableTasks</span><span class="p">(</span><span class="n">job</span><span class="p">,</span><span class="w"> </span><span class="n">TaskType</span><span class="p">.</span><span class="na">MAP</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">             </span><span class="n">runnableReduces</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">runnableTasks</span><span class="p">(</span><span class="n">job</span><span class="p">,</span><span class="w"> </span><span class="n">TaskType</span><span class="p">.</span><span class="na">REDUCE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">         </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">         </span><span class="c1">// ClusterStatus 维护了当前Map/Reduce作业框架的总体状况。</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">         </span><span class="n">ClusterStatus</span><span class="w"> </span><span class="n">clusterStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskTrackerManager</span><span class="p">.</span><span class="na">getClusterStatus</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">         </span><span class="c1">//计算得到获得map task的槽数，reduce task的槽数。</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">totalMapSlots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTotalSlots</span><span class="p">(</span><span class="n">TaskType</span><span class="p">.</span><span class="na">MAP</span><span class="p">,</span><span class="w"> </span><span class="n">clusterStatus</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">totalReduceSlots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTotalSlots</span><span class="p">(</span><span class="n">TaskType</span><span class="p">.</span><span class="na">REDUCE</span><span class="p">,</span><span class="w"> </span><span class="n">clusterStatus</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">         </span><span class="c1">//从job列表中找出那些job需要运行map或reduce任务，加到List&lt;JobInProgress&gt; candidates集合中</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">         </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">         </span><span class="n">TaskType</span><span class="o">[]</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TaskType</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="n">TaskType</span><span class="p">.</span><span class="na">MAP</span><span class="p">,</span><span class="w"> </span><span class="n">TaskType</span><span class="p">.</span><span class="na">REDUCE</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TaskType</span><span class="w"> </span><span class="n">taskType</span><span class="p">:</span><span class="w"> </span><span class="n">types</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">             </span><span class="kt">boolean</span><span class="w"> </span><span class="n">canAssign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">taskType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TaskType</span><span class="p">.</span><span class="na">MAP</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">                     </span><span class="c1">//CapBasedLoadManager方法根据全局的任务槽数，全局的map任务数的比值得到一个load系数，该系数乘以待分配任务的tasktracker的最大map任务数，即是该tasktracker能分配得到的任务数。如果太tracker当前运行的任务数小于可运行的任务数，则任务可以分配新作业给他           </span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">                     </span><span class="n">loadMgr</span><span class="p">.</span><span class="na">canAssignMap</span><span class="p">(</span><span class="n">tracker</span><span class="p">,</span><span class="w"> </span><span class="n">runnableMaps</span><span class="p">,</span><span class="w"> </span><span class="n">totalMapSlots</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">                         </span><span class="n">loadMgr</span><span class="p">.</span><span class="na">canAssignReduce</span><span class="p">(</span><span class="n">tracker</span><span class="p">,</span><span class="w"> </span><span class="n">runnableReduces</span><span class="p">,</span><span class="w"> </span><span class="n">totalReduceSlots</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">canAssign</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">                         </span><span class="n">List</span><span class="o">&lt;</span><span class="n">JobInProgress</span><span class="o">&gt;</span><span class="w"> </span><span class="n">candidates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">JobInProgress</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">                         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">JobInProgress</span><span class="w"> </span><span class="n">job</span><span class="p">:</span><span class="w"> </span><span class="n">infos</span><span class="p">.</span><span class="na">keySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">                             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="na">getStatus</span><span class="p">().</span><span class="na">getRunState</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">JobStatus</span><span class="p">.</span><span class="na">RUNNING</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">                                     </span><span class="n">neededTasks</span><span class="p">(</span><span class="n">job</span><span class="p">,</span><span class="w"> </span><span class="n">taskType</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">                                 </span><span class="n">candidates</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">job</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">                             </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">                         </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">                         </span><span class="c1">//对candidates集合中的job排序，对每个job调用taskSelector的obtainNewMapTask或者obtainNewReduceTask方法获取要执行的task。把所以的task放到task集合中返回。</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">                         </span><span class="c1">// Sort jobs by deficit (for Fair Sharing) or submit time (for FIFO)</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">                         </span><span class="n">Comparator</span><span class="o">&lt;</span><span class="n">JobInProgress</span><span class="o">&gt;</span><span class="w"> </span><span class="n">comparator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">useFifo</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">                                 </span><span class="k">new</span><span class="w"> </span><span class="nf">FifoJobComparator</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DeficitComparator</span><span class="p">(</span><span class="n">taskType</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">                                 </span><span class="n">Collections</span><span class="p">.</span><span class="na">sort</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span><span class="w"> </span><span class="n">comparator</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">                                 </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">JobInProgress</span><span class="w"> </span><span class="n">job</span><span class="p">:</span><span class="w"> </span><span class="n">candidates</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">                                     </span><span class="n">Task</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">taskType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TaskType</span><span class="p">.</span><span class="na">MAP</span><span class="w">  
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">                                             </span><span class="n">taskSelector</span><span class="p">.</span><span class="na">obtainNewMapTask</span><span class="p">(</span><span class="n">tracker</span><span class="p">,</span><span class="w"> </span><span class="n">job</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">                                                 </span><span class="n">taskSelector</span><span class="p">.</span><span class="na">obtainNewReduceTask</span><span class="p">(</span><span class="n">tracker</span><span class="p">,</span><span class="w"> </span><span class="n">job</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">                                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">task</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">                                         </span><span class="c1">//并对candidates集合中的每个job，更新Jobinfo信息，即其正在运行的task数，需要运行的task数。</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">                                         </span><span class="n">JobInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">infos</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">job</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">                                         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">taskType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TaskType</span><span class="p">.</span><span class="na">MAP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">                                             </span><span class="n">info</span><span class="p">.</span><span class="na">runningMaps</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">                                             </span><span class="n">info</span><span class="p">.</span><span class="na">neededMaps</span><span class="o">--</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">                                         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">                                             </span><span class="n">info</span><span class="p">.</span><span class="na">runningReduces</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">                                             </span><span class="n">info</span><span class="p">.</span><span class="na">neededReduces</span><span class="o">--</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">                                         </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">                                         </span><span class="n">tasks</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">task</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">                                         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">assignMultiple</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">                                             </span><span class="k">return</span><span class="w"> </span><span class="n">tasks</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">                                         </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">                                     </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">                                 </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">                     </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w">         </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">         </span><span class="c1">// If no tasks were found, return null</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="n">tasks</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()</span><span class="w">  </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tasks</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w">     </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>**8.CapBasedLoadManager的canAssignMap方法和canAssignReduce方法。**一 种简单的算法在FairScheduler中用来决定是否可以给某个tasktracker分配maptask或者reducetask。总体思路是对于 某种类型的task，map或者reduce，考虑jobtracker管理的mapreduce集群全部的任务数，和全部的任务槽数，和该 tasktracker上面当前的任务数，以决定是否给他分配任务。如对于maptask，根据全局的任务槽数，全局的map任务数的比值得到一个 load系数，该系数乘以待分配任务的tasktracker的最大map任务数，即是该tasktracker能分配得到的任务数。如果太 tracker当前运行的任务数小于可运行的任务数，则任务可以分配新作业给他。reducetask同理。即尽量做到全局平均。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kt">int</span><span class="w"> </span><span class="nf">getCap</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">totalRunnableTasks</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">localMaxTasks</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">totalSlots</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">totalRunnableTasks</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">totalSlots</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">ceil</span><span class="p">(</span><span class="n">localMaxTasks</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">1</span><span class="p">.</span><span class="na">0</span><span class="p">,</span><span class="w"> </span><span class="n">load</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">canAssignMap</span><span class="p">(</span><span class="n">TaskTrackerStatus</span><span class="w"> </span><span class="n">tracker</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">totalRunnableMaps</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">totalMapSlots</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tracker</span><span class="p">.</span><span class="na">countMapTasks</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">getCap</span><span class="p">(</span><span class="n">totalRunnableMaps</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">tracker</span><span class="p">.</span><span class="na">getMaxMapTasks</span><span class="p">(),</span><span class="w"> </span><span class="n">totalMapSlots</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">canAssignReduce</span><span class="p">(</span><span class="n">TaskTrackerStatus</span><span class="w"> </span><span class="n">tracker</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">totalRunnableReduces</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">totalReduceSlots</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tracker</span><span class="p">.</span><span class="na">countReduceTasks</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">getCap</span><span class="p">(</span><span class="n">totalRunnableReduces</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="n">tracker</span><span class="p">.</span><span class="na">getMaxReduceTasks</span><span class="p">(),</span><span class="w"> </span><span class="n">totalReduceSlots</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>9.DefaultTaskSelector继承自TaskSelector，其两个方法其实只是对jobInprogress得封装，没有做什么特别的事情。</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">obtainNewMapTask</span><span class="p">(</span><span class="n">TaskTrackerStatus</span><span class="w"> </span><span class="n">taskTracker</span><span class="p">,</span><span class="w"> </span><span class="n">JobInProgress</span><span class="w"> </span><span class="n">job</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">      </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">ClusterStatus</span><span class="w"> </span><span class="n">clusterStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskTrackerManager</span><span class="p">.</span><span class="na">getClusterStatus</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">numTaskTrackers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clusterStatus</span><span class="p">.</span><span class="na">getTaskTrackers</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">job</span><span class="p">.</span><span class="na">obtainNewMapTask</span><span class="p">(</span><span class="n">taskTracker</span><span class="p">,</span><span class="w"> </span><span class="n">numTaskTrackers</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">taskTrackerManager</span><span class="p">.</span><span class="na">getNumberOfUniqueHosts</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">obtainNewReduceTask</span><span class="p">(</span><span class="n">TaskTrackerStatus</span><span class="w"> </span><span class="n">taskTracker</span><span class="p">,</span><span class="w"> </span><span class="n">JobInProgress</span><span class="w"> </span><span class="n">job</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">      </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="n">ClusterStatus</span><span class="w"> </span><span class="n">clusterStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskTrackerManager</span><span class="p">.</span><span class="na">getClusterStatus</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">numTaskTrackers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clusterStatus</span><span class="p">.</span><span class="na">getTaskTrackers</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">job</span><span class="p">.</span><span class="na">obtainNewReduceTask</span><span class="p">(</span><span class="n">taskTracker</span><span class="p">,</span><span class="w"> </span><span class="n">numTaskTrackers</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="n">taskTrackerManager</span><span class="p">.</span><span class="na">getNumberOfUniqueHosts</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>10. JobInProgress的obtainNewMapTask方法。其实主要逻辑是在findNewMapTask方法中实现。</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">obtainNewMapTask</span><span class="p">(</span><span class="n">TaskTrackerStatus</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">                                            </span><span class="kt">int</span><span class="w"> </span><span class="n">clusterSize</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">                                            </span><span class="kt">int</span><span class="w"> </span><span class="n">numUniqueHosts</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">                                           </span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findNewMapTask</span><span class="p">(</span><span class="n">tts</span><span class="p">,</span><span class="w"> </span><span class="n">clusterSize</span><span class="p">,</span><span class="w"> </span><span class="n">numUniqueHosts</span><span class="p">,</span><span class="w"> </span><span class="n">anyCacheLevel</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">                                </span><span class="n">status</span><span class="p">.</span><span class="na">mapProgress</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">Task</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maps</span><span class="o">[</span><span class="n">target</span><span class="o">]</span><span class="p">.</span><span class="na">getTaskToRun</span><span class="p">(</span><span class="n">tts</span><span class="p">.</span><span class="na">getTrackerName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">      </span><span class="n">addRunningTaskToTIP</span><span class="p">(</span><span class="n">maps</span><span class="o">[</span><span class="n">target</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getTaskID</span><span class="p">(),</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>11 JobInProgress的findNewMapTask方法。</strong></p>
<p>根据待派发Task的TaskTracker根据集群中的TaskTracker数量（<strong>clusterSize</strong>），运行TraskTracker的服务器数（<strong>numUniqueHosts</strong>），该Job中map task的平均进度（<strong>avgProgress</strong>），可以调度map的最大水平（距离其实），选择一个task执行。考虑到map的本地化。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">findNewMapTask</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">TaskTrackerStatus</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">clusterSize</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numUniqueHosts</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxCacheLevel</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">avgProgress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">taskTracker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tts</span><span class="p">.</span><span class="na">getTrackerName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">        </span><span class="n">TaskInProgress</span><span class="w"> </span><span class="n">tip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">        </span><span class="c1">//1）更新TaskTracker总数。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">clusterSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clusterSize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">        </span><span class="c1">//2）如果这个TraskTracker上面之前有很多map都会失败，则返回标记，不分配给他。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">shouldRunOnTaskTracker</span><span class="p">(</span><span class="n">taskTracker</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">            </span><span class="c1">//3） 检查该TaskTracker有足够的资源运行。估算output的方法有点意思，根据（job现有的map数+当前job的map数）*已完成map数*2*已完成的map的输出size/已经完成map的输入size，即根据完成估算总数。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">outSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resourceEstimator</span><span class="p">.</span><span class="na">getEstimatedMapOutputSize</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">availSpace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tts</span><span class="p">.</span><span class="na">getResourceStatus</span><span class="p">().</span><span class="na">getAvailableSpace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">availSpace</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">outSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">                </span><span class="n">LOG</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&#34;No room for map task. Node &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tts</span><span class="p">.</span><span class="na">getHost</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">                        </span><span class="s">&#34; has &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">availSpace</span><span class="w"> </span><span class="o">+</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">                        </span><span class="s">&#34; bytes free; but we expect map to take &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">outSize</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">            </span><span class="c1">// For scheduling a map task, we have two caches and a list (optional)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">            </span><span class="c1">//  I)   one for non-running task</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">            </span><span class="c1">//  II)  one for running task (this is for handling speculation)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">            </span><span class="c1">//  III) a list of TIPs that have empty locations (e.g., dummy splits),</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">            </span><span class="c1">//       the list is empty if all TIPs have associated locations</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">            </span><span class="c1">// First a look up is done on the non-running cache and on a miss, a look </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">            </span><span class="c1">// up is done on the running cache. The order for lookup within the cache:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">            </span><span class="c1">//   1. from local node to root [bottom up]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">            </span><span class="c1">//   2. breadth wise for all the parent nodes at max level</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">            </span><span class="c1">// We fall to linear scan of the list (III above) if we have misses in the </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">            </span><span class="c1">// above caches</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">            </span><span class="c1">//4）获得jobTracker所在的Node</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jobtracker</span><span class="p">.</span><span class="na">getNode</span><span class="p">(</span><span class="n">tts</span><span class="p">.</span><span class="na">getHost</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">            </span><span class="c1">// I) Non-running TIP :</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">            </span><span class="c1">//5） 从未运行的作业集合中选择一个nonRunningMapCache 加入到运行集合runningMapCache中。加入时根据待添加的Task的split的位置信息，在runningMapCache中保存Node和Task集合的对应关系。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">            </span><span class="c1">// 1. check from local node to the root [bottom up cache lookup]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">            </span><span class="c1">//    i.e if the cache is available and the host has been resolved</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">            </span><span class="c1">//    (node!=null)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">                </span><span class="n">Node</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">                </span><span class="c1">// maxCacheLevel might be greater than this.maxLevel if findNewMapTask is</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">                </span><span class="c1">// called to schedule any task (local, rack-local, off-switch or speculative)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">                </span><span class="c1">// tasks or it might be NON_LOCAL_CACHE_LEVEL (i.e. -1) if findNewMapTask is</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">                </span><span class="c1">//  (i.e. -1) if findNewMapTask is to only schedule off-switch/speculative</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">                </span><span class="c1">// tasks</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">                </span><span class="c1">//从taskTracker本地开始由近至远查找要加入的Task 到runningMapCache中。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">maxLevelToSchedule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">maxCacheLevel</span><span class="p">,</span><span class="w"> </span><span class="n">maxLevel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxLevelToSchedule</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">                    </span><span class="n">List</span><span class="w"> </span><span class="o">&lt;</span><span class="n">TaskInProgress</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cacheForLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nonRunningMapCache</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cacheForLevel</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">                        </span><span class="n">tip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findTaskFromList</span><span class="p">(</span><span class="n">cacheForLevel</span><span class="p">,</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">                                </span><span class="n">numUniqueHosts</span><span class="p">,</span><span class="n">level</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tip</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">                            </span><span class="c1">// 把该map任务加入到runningMapCache</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">                            </span><span class="n">scheduleMap</span><span class="p">(</span><span class="n">tip</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">                            </span><span class="k">return</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getIdWithinJob</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">                    </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">getParent</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">                </span><span class="c1">// Check if we need to only schedule a local task (node-local/rack-local)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">maxCacheLevel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">            </span><span class="c1">//2. Search breadth-wise across parents at max level for non-running </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">            </span><span class="c1">//   TIP if</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">            </span><span class="c1">//     - cache exists and there is a cache miss </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">            </span><span class="c1">//     - node information for the tracker is missing (tracker&#39;s topology</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">            </span><span class="c1">//       info not obtained yet)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">            </span><span class="c1">// collection of node at max level in the cache structure</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">            </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nodesAtMaxLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jobtracker</span><span class="p">.</span><span class="na">getNodesAtMaxLevel</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">            </span><span class="c1">// get the node parent at max level</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="w"> </span><span class="n">nodeParentAtMaxLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">                    </span><span class="p">(</span><span class="n">node</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w">  </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">JobTracker</span><span class="p">.</span><span class="na">getParentNode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">maxLevel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">nodesAtMaxLevel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">                </span><span class="c1">// skip the parent that has already been scanned</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nodeParentAtMaxLevel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">                </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TaskInProgress</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nonRunningMapCache</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cache</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">                    </span><span class="n">tip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findTaskFromList</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> </span><span class="n">numUniqueHosts</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tip</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">                        </span><span class="c1">// Add to the running cache</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">                        </span><span class="n">scheduleMap</span><span class="p">(</span><span class="n">tip</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">                        </span><span class="c1">// remove the cache if empty</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cache</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">                            </span><span class="n">nonRunningMapCache</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">                        </span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Choosing a non-local task &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getTIPId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getIdWithinJob</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w">            </span><span class="c1">//搜索非本地Map</span><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w">            </span><span class="n">tip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findTaskFromList</span><span class="p">(</span><span class="n">nonLocalMaps</span><span class="p">,</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> </span><span class="n">numUniqueHosts</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tip</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w">                </span><span class="c1">// Add to the running list</span><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w">                </span><span class="n">scheduleMap</span><span class="p">(</span><span class="n">tip</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">122</span><span class="cl"><span class="w">                </span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Choosing a non-local task &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getTIPId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getIdWithinJob</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">125</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">126</span><span class="cl"><span class="w">            </span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="w">            </span><span class="c1">// II) Running TIP :</span><span class="w">
</span></span></span><span class="line"><span class="ln">128</span><span class="cl"><span class="w">            </span><span class="c1">// </span><span class="w">
</span></span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">130</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasSpeculativeMaps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">131</span><span class="cl"><span class="w">                </span><span class="kt">long</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">132</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="w">                </span><span class="c1">// 1. Check bottom up for speculative tasks from the running cache</span><span class="w">
</span></span></span><span class="line"><span class="ln">134</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="w">                    </span><span class="n">Node</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxLevel</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">137</span><span class="cl"><span class="w">                        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TaskInProgress</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cacheForLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runningMapCache</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cacheForLevel</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="w">                            </span><span class="n">tip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findSpeculativeTask</span><span class="p">(</span><span class="n">cacheForLevel</span><span class="p">,</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="w">                                    </span><span class="n">avgProgress</span><span class="p">,</span><span class="w"> </span><span class="n">currentTime</span><span class="p">,</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tip</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cacheForLevel</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">143</span><span class="cl"><span class="w">                                    </span><span class="n">runningMapCache</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">144</span><span class="cl"><span class="w">                                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">145</span><span class="cl"><span class="w">                                </span><span class="k">return</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getIdWithinJob</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">146</span><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">147</span><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">148</span><span class="cl"><span class="w">                        </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">getParent</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">149</span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">150</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">151</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">152</span><span class="cl"><span class="w">                </span><span class="c1">// 2. Check breadth-wise for speculative tasks</span><span class="w">
</span></span></span><span class="line"><span class="ln">153</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">154</span><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">nodesAtMaxLevel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">155</span><span class="cl"><span class="w">                    </span><span class="c1">// ignore the parent which is already scanned</span><span class="w">
</span></span></span><span class="line"><span class="ln">156</span><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nodeParentAtMaxLevel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">157</span><span class="cl"><span class="w">                        </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">158</span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">159</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">160</span><span class="cl"><span class="w">                    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TaskInProgress</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runningMapCache</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">161</span><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cache</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">162</span><span class="cl"><span class="w">                        </span><span class="n">tip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findSpeculativeTask</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> </span><span class="n">avgProgress</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">163</span><span class="cl"><span class="w">                                </span><span class="n">currentTime</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">164</span><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tip</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">165</span><span class="cl"><span class="w">                            </span><span class="c1">// remove empty cache entries</span><span class="w">
</span></span></span><span class="line"><span class="ln">166</span><span class="cl"><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cache</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">167</span><span class="cl"><span class="w">                                </span><span class="n">runningMapCache</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">168</span><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">169</span><span class="cl"><span class="w">                            </span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Choosing a non-local task &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getTIPId</span><span class="p">()</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">170</span><span class="cl"><span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; for speculation&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">171</span><span class="cl"><span class="w">                            </span><span class="k">return</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getIdWithinJob</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">172</span><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">173</span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">174</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">175</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">176</span><span class="cl"><span class="w">                </span><span class="c1">// 3. Check non-local tips for speculation</span><span class="w">
</span></span></span><span class="line"><span class="ln">177</span><span class="cl"><span class="w">                </span><span class="n">tip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findSpeculativeTask</span><span class="p">(</span><span class="n">nonLocalRunningMaps</span><span class="p">,</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> </span><span class="n">avgProgress</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">178</span><span class="cl"><span class="w">                        </span><span class="n">currentTime</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">179</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tip</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">180</span><span class="cl"><span class="w">                    </span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Choosing a non-local task &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getTIPId</span><span class="p">()</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">181</span><span class="cl"><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; for speculation&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">182</span><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getIdWithinJob</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">183</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">184</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">185</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">186</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">187</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">188</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>12 JobInProgress的obtainNewReduceTask方法返回一个ReduceTask，实际调用的是findNewReduceTask方法。</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">obtainNewReduceTask</span><span class="p">(</span><span class="n">TaskTrackerStatus</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">                                               </span><span class="kt">int</span><span class="w"> </span><span class="n">clusterSize</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">                                               </span><span class="kt">int</span><span class="w"> </span><span class="n">numUniqueHosts</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">                                              </span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="c1">//判定有足够的map已经完成。，</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">scheduleReduces</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w">  </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findNewReduceTask</span><span class="p">(</span><span class="n">tts</span><span class="p">,</span><span class="w"> </span><span class="n">clusterSize</span><span class="p">,</span><span class="w"> </span><span class="n">numUniqueHosts</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">                                    </span><span class="n">status</span><span class="p">.</span><span class="na">reduceProgress</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">Task</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reduces</span><span class="o">[</span><span class="n">target</span><span class="o">]</span><span class="p">.</span><span class="na">getTaskToRun</span><span class="p">(</span><span class="n">tts</span><span class="p">.</span><span class="na">getTrackerName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">      </span><span class="n">addRunningTaskToTIP</span><span class="p">(</span><span class="n">reduces</span><span class="o">[</span><span class="n">target</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getTaskID</span><span class="p">(),</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>13 JobInProgress的findNewReduceTask方法，为指定的TaskTracker选择Reduce task。不用考虑本地化。</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">findNewReduceTask</span><span class="p">(</span><span class="n">TaskTrackerStatus</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">                                             </span><span class="kt">int</span><span class="w"> </span><span class="n">clusterSize</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">                                             </span><span class="kt">int</span><span class="w"> </span><span class="n">numUniqueHosts</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="n">avgProgress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">taskTracker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tts</span><span class="p">.</span><span class="na">getTrackerName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">TaskInProgress</span><span class="w"> </span><span class="n">tip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="c1">// Update the last-known clusterSize</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">clusterSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clusterSize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="c1">// 该taskTracker可用性符合要求</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">shouldRunOnTaskTracker</span><span class="p">(</span><span class="n">taskTracker</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">//估算Reduce的输入，根据map的总输出来和reduce的个数来计算。</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">outSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resourceEstimator</span><span class="p">.</span><span class="na">getEstimatedReduceInputSize</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">availSpace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tts</span><span class="p">.</span><span class="na">getResourceStatus</span><span class="p">().</span><span class="na">getAvailableSpace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">availSpace</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">outSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">      </span><span class="n">LOG</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&#34;No room for reduce task. Node &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">taskTracker</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; has &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">                </span><span class="n">availSpace</span><span class="w"> </span><span class="o">+</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">               </span><span class="s">&#34; bytes free; but we expect reduce input to take &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">outSize</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="c1">//see if a different TIP might work better. </span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="c1">// 1. check for a never-executed reduce tip</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="c1">// reducers don&#39;t have a cache and so pass -1 to explicitly call that out</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="n">tip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findTaskFromList</span><span class="p">(</span><span class="n">nonRunningReduces</span><span class="p">,</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> </span><span class="n">numUniqueHosts</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tip</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">      </span><span class="n">scheduleReduce</span><span class="p">(</span><span class="n">tip</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getIdWithinJob</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="c1">// 2. check for a reduce tip to be speculated</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasSpeculativeReduces</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">      </span><span class="n">tip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findSpeculativeTask</span><span class="p">(</span><span class="n">runningReduces</span><span class="p">,</span><span class="w"> </span><span class="n">tts</span><span class="p">,</span><span class="w"> </span><span class="n">avgProgress</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">                                </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">(),</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tip</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="n">scheduleReduce</span><span class="p">(</span><span class="n">tip</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tip</span><span class="p">.</span><span class="na">getIdWithinJob</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>14 TaskTracker 的addToTaskQueue方法。对于要launch的task加入到taskQueue中去，不同类型的Task有不同类型额launcher。</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addToTaskQueue</span><span class="p">(</span><span class="n">LaunchTaskAction</span><span class="w"> </span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="na">getTask</span><span class="p">().</span><span class="na">isMapTask</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">      </span><span class="n">mapLauncher</span><span class="p">.</span><span class="na">addToTaskQueue</span><span class="p">(</span><span class="n">action</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">      </span><span class="n">reduceLauncher</span><span class="p">.</span><span class="na">addToTaskQueue</span><span class="p">(</span><span class="n">action</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>完。</p>

    </div>
<div class="post_comments">
  
  
  
</div>




  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <br>
    
  
  <div class="search">
    <input type="search" class="search_field form_field" placeholder='Search...' id="find" autocomplete="off" data-scope='posts'>
    <label for="find" class="search_label"><svg class="icon">
  <title>search</title>
  <use xlink:href="#search"></use>
</svg>

    </label>
    
    <div class="search_results results"></div>
  </div>


    
    
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
      <li>
        <a href="https://idouba.com/about/" class="nav-link" title="About">About</a>
      </li>
      <li>
        <a href="https://idouba.com/doudou-and-douba-drive-around-taihu-day1/" class="nav-link" title="豆哥国庆环太湖Day1">豆哥国庆环太湖Day1</a>
      </li>
      <li>
        <a href="https://idouba.com/doudou-military-training/" class="nav-link" title="豆哥军训归来">豆哥军训归来</a>
      </li>
      <li>
        <a href="https://idouba.com/doudou-first-day-of-new-term/" class="nav-link" title="开学第一天和豆哥奇妙的拼车之旅">开学第一天和豆哥奇妙的拼车之旅</a>
      </li>
      <li>
        <a href="https://idouba.com/kubecon2024-best-practice-karmada-and-istio-improve-workload-traffic-resilience-of-production-distributed-cloud/" class="nav-link" title="KubeCon2024：Karmda和Istio提高分布式云的负载与流量韧性的最佳实践">KubeCon2024：Karmda和Istio提高分布式云的负载与流量韧性的最佳实践</a>
      </li>
      <li>
        <a href="https://idouba.com/kubecon2023-detailed-parse-and-reproduce-istio-response-flags-index/" class="nav-link" title="KubeCon2023：基于实际案例解析Istio访问日志ResponseFlag系列">KubeCon2023：基于实际案例解析Istio访问日志ResponseFlag系列</a>
      </li>
      <li>
        <a href="https://idouba.com/detailed-parse-and-reproduce-istio-response-flags-14-RL/" class="nav-link" title="RL(服务限流)--Istio访问日志ResponseFlag重现与解析14">RL(服务限流)--Istio访问日志ResponseFlag重现与解析14</a>
      </li>
      <li>
        <a href="https://idouba.com/detailed-parse-and-reproduce-istio-response-flags-13-RL/" class="nav-link" title="RL(服务限流)--Istio访问日志ResponseFlag重现与解析13">RL(服务限流)--Istio访问日志ResponseFlag重现与解析13</a>
      </li>
    </ul>
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">Categories</h2>
      <nav class="tags_nav">
        <a href='https://idouba.com/categories/istio/' class="post_tag button button_translucent" title="istio">
          ISTIO
          <span class="button_tally">45</span>
        </a>
        
        <a href='https://idouba.com/categories/%E9%9A%8F%E7%AC%94/' class="post_tag button button_translucent" title="随笔">
          随笔
          <span class="button_tally">18</span>
        </a>
        
        <a href='https://idouba.com/categories/hadoop/' class="post_tag button button_translucent" title="hadoop">
          HADOOP
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://idouba.com/categories/istio%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/' class="post_tag button button_translucent" title="istio权威指南">
          ISTIO权威指南
          <span class="button_tally">11</span>
        </a>
        
        <a href='https://idouba.com/categories/%E6%BC%94%E8%AE%B2/' class="post_tag button button_translucent" title="演讲">
          演讲
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://idouba.com/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/' class="post_tag button button_translucent" title="数据库">
          数据库
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://idouba.com/categories/%E5%8F%91%E8%A1%A8/' class="post_tag button button_translucent" title="发表">
          发表
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://idouba.com/categories/kubecon/' class="post_tag button button_translucent" title="kubecon">
          KUBECON
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://idouba.com/categories/%E5%9B%BE%E4%B9%A6/' class="post_tag button button_translucent" title="图书">
          图书
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://idouba.com/categories/golang/' class="post_tag button button_translucent" title="golang">
          GOLANG
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://idouba.com/categories/istiocon/' class="post_tag button button_translucent" title="istiocon">
          ISTIOCON
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://idouba.com/categories/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://idouba.com/categories/%E5%B9%B6%E5%8F%91/' class="post_tag button button_translucent" title="并发">
          并发
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://idouba.com/categories/%E8%B1%86%E5%93%A5/' class="post_tag button button_translucent" title="豆哥">
          豆哥
          <span class="button_tally">3</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Categories</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://idouba.com/categories/golang/' class=" post_tag button button_translucent" data-position=3 title="golang">GOLANG<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/categories/hadoop/' class=" post_tag button button_translucent" data-position=12 title="hadoop">HADOOP<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://idouba.com/categories/istio/' class=" post_tag button button_translucent" data-position=45 title="istio">ISTIO<span class="button_tally">45</span>
            </a>
            
            
            <a href='https://idouba.com/categories/istiocon/' class=" post_tag button button_translucent" data-position=3 title="istiocon">ISTIOCON<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/categories/istio%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/' class=" post_tag button button_translucent" data-position=11 title="istio权威指南">ISTIO权威指南<span class="button_tally">11</span>
            </a>
            
            
            <a href='https://idouba.com/categories/jvm/' class=" post_tag button button_translucent" data-position=1 title="jvm">JVM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/categories/karmada/' class=" post_tag button button_translucent" data-position=1 title="karmada">KARMADA<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/categories/kubecon/' class=" post_tag button button_translucent" data-position=4 title="kubecon">KUBECON<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://idouba.com/categories/kubernetes/' class=" post_tag button button_translucent" data-position=3 title="kubernetes">KUBERNETES<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/categories/servicemeshcon/' class=" post_tag button button_translucent" data-position=1 title="servicemeshcon">SERVICEMESHCON<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/categories/%E5%8F%91%E8%A1%A8/' class=" post_tag button button_translucent" data-position=6 title="发表">发表<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://idouba.com/categories/%E5%9B%BE%E4%B9%A6/' class=" post_tag button button_translucent" data-position=4 title="图书">图书<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://idouba.com/categories/%E5%B9%B6%E5%8F%91/' class=" post_tag button button_translucent" data-position=3 title="并发">并发<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/' class=" post_tag button button_translucent" data-position=7 title="数据库">数据库<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://idouba.com/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/' class=" post_tag button button_translucent" data-position=2 title="机器学习">机器学习<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/categories/%E6%BC%94%E8%AE%B2/' class=" post_tag button button_translucent" data-position=9 title="演讲">演讲<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://idouba.com/categories/%E8%B1%86%E5%93%A5/' class=" post_tag button button_translucent" data-position=3 title="豆哥">豆哥<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/categories/%E9%9A%8F%E7%AC%94/' class=" post_tag button button_translucent" data-position=18 title="随笔">随笔<span class="button_tally">18</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">Tags</h2>
      <nav class="tags_nav">
        <a href='https://idouba.com/tags/istio/' class="post_tag button button_translucent" title="istio">
          ISTIO
          <span class="button_tally">28</span>
        </a>
        
        <a href='https://idouba.com/tags/%E6%BC%94%E8%AE%B2/' class="post_tag button button_translucent" title="演讲">
          演讲
          <span class="button_tally">23</span>
        </a>
        
        <a href='https://idouba.com/tags/kubecon/' class="post_tag button button_translucent" title="kubecon">
          KUBECON
          <span class="button_tally">20</span>
        </a>
        
        <a href='https://idouba.com/tags/java/' class="post_tag button button_translucent" title="java">
          JAVA
          <span class="button_tally">17</span>
        </a>
        
        <a href='https://idouba.com/tags/%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97/' class="post_tag button button_translucent" title="访问日志">
          访问日志
          <span class="button_tally">16</span>
        </a>
        
        <a href='https://idouba.com/tags/responseflags/' class="post_tag button button_translucent" title="responseflags">
          RESPONSEFLAGS
          <span class="button_tally">15</span>
        </a>
        
        <a href='https://idouba.com/tags/mapreduce/' class="post_tag button button_translucent" title="mapreduce">
          MAPREDUCE
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://idouba.com/tags/hadoop/' class="post_tag button button_translucent" title="hadoop">
          HADOOP
          <span class="button_tally">11</span>
        </a>
        
        <a href='https://idouba.com/tags/istio%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/' class="post_tag button button_translucent" title="istio权威指南">
          ISTIO权威指南
          <span class="button_tally">11</span>
        </a>
        
        <a href='https://idouba.com/tags/%E5%9B%BE%E4%B9%A6/' class="post_tag button button_translucent" title="图书">
          图书
          <span class="button_tally">11</span>
        </a>
        
        <a href='https://idouba.com/tags/%E9%9A%8F%E7%AC%94/' class="post_tag button button_translucent" title="随笔">
          随笔
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://idouba.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BCistio%E5%8E%9F%E7%90%86%E5%AE%9E%E8%B7%B5%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/' class="post_tag button button_translucent" title="云原生服务网格istio原理实践架构与源码解析">
          云原生服务网格ISTIO原理实践架构与源码解析
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://idouba.com/tags/golang/' class="post_tag button button_translucent" title="golang">
          GOLANG
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://idouba.com/tags/%E8%B1%86%E5%93%A5/' class="post_tag button button_translucent" title="豆哥">
          豆哥
          <span class="button_tally">4</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Tags</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://idouba.com/tags/12306/' class=" post_tag button button_translucent" data-position=1 title="12306">12306<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/about/' class=" post_tag button button_translucent" data-position=1 title="about">ABOUT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/aqs/' class=" post_tag button button_translucent" data-position=1 title="aqs">AQS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/authorizationpolicy/' class=" post_tag button button_translucent" data-position=1 title="authorizationpolicy">AUTHORIZATIONPOLICY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/dc/' class=" post_tag button button_translucent" data-position=1 title="dc">DC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/di/' class=" post_tag button button_translucent" data-position=1 title="di">DI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/doudou/' class=" post_tag button button_translucent" data-position=3 title="doudou">DOUDOU<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/dpe/' class=" post_tag button button_translucent" data-position=1 title="dpe">DPE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/english/' class=" post_tag button button_translucent" data-position=1 title="english">ENGLISH<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/executor/' class=" post_tag button button_translucent" data-position=2 title="executor">EXECUTOR<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/fi/' class=" post_tag button button_translucent" data-position=1 title="fi">FI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/g20/' class=" post_tag button button_translucent" data-position=1 title="g20">G20<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/golang/' class=" post_tag button button_translucent" data-position=4 title="golang">GOLANG<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://idouba.com/tags/gre/' class=" post_tag button button_translucent" data-position=1 title="gre">GRE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/hadoop/' class=" post_tag button button_translucent" data-position=11 title="hadoop">HADOOP<span class="button_tally">11</span>
            </a>
            
            
            <a href='https://idouba.com/tags/infoq/' class=" post_tag button button_translucent" data-position=3 title="infoq">INFOQ<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/istio/' class=" post_tag button button_translucent" data-position=28 title="istio">ISTIO<span class="button_tally">28</span>
            </a>
            
            
            <a href='https://idouba.com/tags/istiocon/' class=" post_tag button button_translucent" data-position=3 title="istiocon">ISTIOCON<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/istio%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/' class=" post_tag button button_translucent" data-position=11 title="istio权威指南">ISTIO权威指南<span class="button_tally">11</span>
            </a>
            
            
            <a href='https://idouba.com/tags/japanese/' class=" post_tag button button_translucent" data-position=1 title="japanese">JAPANESE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/java/' class=" post_tag button button_translucent" data-position=17 title="java">JAVA<span class="button_tally">17</span>
            </a>
            
            
            <a href='https://idouba.com/tags/jvm/' class=" post_tag button button_translucent" data-position=1 title="jvm">JVM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/k-medoids/' class=" post_tag button button_translucent" data-position=1 title="k-medoids">K-MEDOIDS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/karmada/' class=" post_tag button button_translucent" data-position=1 title="karmada">KARMADA<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/kubecon/' class=" post_tag button button_translucent" data-position=20 title="kubecon">KUBECON<span class="button_tally">20</span>
            </a>
            
            
            <a href='https://idouba.com/tags/kubernetes/' class=" post_tag button button_translucent" data-position=3 title="kubernetes">KUBERNETES<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/mapreduce/' class=" post_tag button button_translucent" data-position=12 title="mapreduce">MAPREDUCE<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://idouba.com/tags/nc/' class=" post_tag button button_translucent" data-position=1 title="nc">NC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/nr/' class=" post_tag button button_translucent" data-position=1 title="nr">NR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/oracle/' class=" post_tag button button_translucent" data-position=3 title="oracle">ORACLE<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/pilot/' class=" post_tag button button_translucent" data-position=2 title="pilot">PILOT<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/responseflags/' class=" post_tag button button_translucent" data-position=15 title="responseflags">RESPONSEFLAGS<span class="button_tally">15</span>
            </a>
            
            
            <a href='https://idouba.com/tags/rl/' class=" post_tag button button_translucent" data-position=2 title="rl">RL<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/rpc/' class=" post_tag button button_translucent" data-position=1 title="rpc">RPC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/serviceentry/' class=" post_tag button button_translucent" data-position=1 title="serviceentry">SERVICEENTRY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/servicemeshcon/' class=" post_tag button button_translucent" data-position=1 title="servicemeshcon">SERVICEMESHCON<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/source/' class=" post_tag button button_translucent" data-position=2 title="source">SOURCE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/spring-cloud/' class=" post_tag button button_translucent" data-position=1 title="spring-cloud">SPRING-CLOUD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/springcloud/' class=" post_tag button button_translucent" data-position=1 title="springcloud">SPRINGCLOUD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/uc/' class=" post_tag button button_translucent" data-position=1 title="uc">UC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/uf/' class=" post_tag button button_translucent" data-position=1 title="uf">UF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/uh/' class=" post_tag button button_translucent" data-position=1 title="uh">UH<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/upe/' class=" post_tag button button_translucent" data-position=1 title="upe">UPE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/urx/' class=" post_tag button button_translucent" data-position=1 title="urx">URX<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/ut/' class=" post_tag button button_translucent" data-position=1 title="ut">UT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E3%81%AB%E3%81%BB%E3%82%93%E3%81%94/' class=" post_tag button button_translucent" data-position=1 title="にほんご">にほんご<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E4%BA%8B%E5%8A%A1/' class=" post_tag button button_translucent" data-position=1 title="事务">事务<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BCistio%E5%8E%9F%E7%90%86%E5%AE%9E%E8%B7%B5%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/' class=" post_tag button button_translucent" data-position=6 title="云原生服务网格istio原理实践架构与源码解析">云原生服务网格ISTIO原理实践架构与源码解析<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E4%BF%A1/' class=" post_tag button button_translucent" data-position=2 title="信">信<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%85%B3%E4%BA%8E/' class=" post_tag button button_translucent" data-position=1 title="关于">关于<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%86%9B%E8%AE%AD/' class=" post_tag button button_translucent" data-position=2 title="军训">军训<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%88%86%E7%B1%BB/' class=" post_tag button button_translucent" data-position=1 title="分类">分类<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%8F%91%E8%A1%A8/' class=" post_tag button button_translucent" data-position=1 title="发表">发表<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%9B%BD%E9%99%85%E7%B1%B3%E5%85%B0/' class=" post_tag button button_translucent" data-position=1 title="国际米兰">国际米兰<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%9B%BE%E4%B9%A6/' class=" post_tag button button_translucent" data-position=11 title="图书">图书<span class="button_tally">11</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/' class=" post_tag button button_translucent" data-position=1 title="垃圾回收">垃圾回收<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%A4%9A%E9%9B%86%E7%BE%A4/' class=" post_tag button button_translucent" data-position=2 title="多集群">多集群<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%A4%AA%E6%B9%96/' class=" post_tag button button_translucent" data-position=1 title="太湖">太湖<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%AE%89%E5%85%A8/' class=" post_tag button button_translucent" data-position=2 title="安全">安全<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%AE%9E%E8%B7%B5/' class=" post_tag button button_translucent" data-position=1 title="实践">实践<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%B9%B6%E5%8F%91/' class=" post_tag button button_translucent" data-position=1 title="并发">并发<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/' class=" post_tag button button_translucent" data-position=1 title="微服务">微服务<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/' class=" post_tag button button_translucent" data-position=1 title="执行计划">执行计划<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/' class=" post_tag button button_translucent" data-position=1 title="数据库">数据库<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%96%B0%E5%86%A0/' class=" post_tag button button_translucent" data-position=1 title="新冠">新冠<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%97%85%E6%B8%B8/' class=" post_tag button button_translucent" data-position=1 title="旅游">旅游<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/' class=" post_tag button button_translucent" data-position=3 title="最佳实践">最佳实践<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/' class=" post_tag button button_translucent" data-position=3 title="服务网格">服务网格<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/' class=" post_tag button button_translucent" data-position=1 title="机器学习">机器学习<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%BC%94%E8%AE%B2/' class=" post_tag button button_translucent" data-position=23 title="演讲">演讲<span class="button_tally">23</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E7%A5%96%E6%AF%8D/' class=" post_tag button button_translucent" data-position=2 title="祖母">祖母<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/' class=" post_tag button button_translucent" data-position=3 title="程序员">程序员<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E7%B4%A2%E5%BC%95/' class=" post_tag button button_translucent" data-position=3 title="索引">索引<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%81%9A%E7%B1%BB/' class=" post_tag button button_translucent" data-position=1 title="聚类">聚类<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%A1%A8%E8%BF%9E%E6%8E%A5/' class=" post_tag button button_translucent" data-position=1 title="表连接">表连接<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%A5%BF%E5%AE%89/' class=" post_tag button button_translucent" data-position=1 title="西安">西安<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97/' class=" post_tag button button_translucent" data-position=16 title="访问日志">访问日志<span class="button_tally">16</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%B0%83%E7%94%A8%E9%93%BE/' class=" post_tag button button_translucent" data-position=2 title="调用链">调用链<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%B1%86%E5%93%A5/' class=" post_tag button button_translucent" data-position=4 title="豆哥">豆哥<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%B1%86%E7%88%B8/' class=" post_tag button button_translucent" data-position=1 title="豆爸">豆爸<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%B6%B3%E7%90%83/' class=" post_tag button button_translucent" data-position=1 title="足球">足球<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E9%93%81%E8%B7%AF/' class=" post_tag button button_translucent" data-position=1 title="铁路">铁路<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E9%9A%8F%E7%AC%94/' class=" post_tag button button_translucent" data-position=7 title="随笔">随笔<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E9%9F%A7%E6%80%A7/' class=" post_tag button button_translucent" data-position=1 title="韧性">韧性<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
  </section>
</aside>

  
</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab">
    <path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6 0L12.3 74.8z" />
    <path d="M12.3 74.7L.5 111c-1 3.2 0 6.8 3 8.8l101.6 74-92.5-119z"/>
    <path d="M105 193.7l-38.6-119h-54l92.7 119z"/>
    <path d="M105 193.7l38.7-119H66.4l38.7 119z"/>
    <path d="M105 193.7l38.7-119H198l-93 119z"/>
    <path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/>
    <path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6 0L198 74.8z"/>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M23 2.75A2.75 2.75 0 0 0 20.25 0H8.75A2.75 2.75 0 0 0 6 2.75v13.5A2.75 2.75 0 0 0 8.75 19h11.5A2.75 2.75 0 0 0 23 16.25zM18.25 14.5h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5z"></path>
    <path d="M8.75 20.5a4.255 4.255 0 0 1-4.25-4.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752 0 0 0 1 5.25v16A2.752 2.752 0 0 0 3.75 24h12a2.752 2.752 0 0 0 2.75-2.75v-.75z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram">
    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id=youtube>
    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow">
    <path d="M21 27v-8h3v11H0V19h3v8h18z"></path><path d="M17.1.2L15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8l13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing">
    <path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord">
    <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 18" id="mastodon">
    <path
    fill="#ffffff"
    d="m 15.054695,9.8859583 c -0.22611,1.1632697 -2.02517,2.4363497 -4.09138,2.6830797 -1.0774504,0.12856 -2.1382704,0.24673 -3.2694704,0.19484 -1.84996,-0.0848 -3.30971,-0.44157 -3.30971,-0.44157 0,0.1801 0.0111,0.35157 0.0333,0.51194 0.24051,1.82571 1.81034,1.93508 3.29737,1.98607 1.50088,0.0514 2.8373104,-0.37004 2.8373104,-0.37004 l 0.0617,1.35686 c 0,0 -1.0498104,0.56374 -2.9199404,0.66742 -1.03124,0.0567 -2.3117,-0.0259 -3.80308,-0.42069 -3.23454998,-0.85613 -3.79081998,-4.304 -3.87592998,-7.8024197 -0.026,-1.03871 -0.01,-2.01815 -0.01,-2.83732 0,-3.57732 2.34385998,-4.62587996 2.34385998,-4.62587996 1.18184,-0.54277 3.20976,-0.77101 5.318,-0.7882499985409 h 0.0518 C 9.8267646,0.01719834 11.856025,0.24547834 13.037775,0.78824834 c 0,0 2.34377,1.04855996 2.34377,4.62587996 0,0 0.0294,2.63937 -0.32687,4.47183"/>
 <path
    fill="#000000"
    d="m 12.616925,5.6916583 v 4.3315297 h -1.71607 V 5.8189683 c 0,-0.88624 -0.37289,-1.33607 -1.1187604,-1.33607 -0.82467,0 -1.23799,0.53361 -1.23799,1.58875 v 2.30122 h -1.70594 v -2.30122 c 0,-1.05514 -0.4134,-1.58875 -1.23808,-1.58875 -0.74587,0 -1.11876,0.44983 -1.11876,1.33607 v 4.2042197 h -1.71607 V 5.6916583 c 0,-0.88527 0.22541,-1.58876 0.67817,-2.10922 0.46689,-0.52047 1.07833,-0.78727 1.83735,-0.78727 0.87816,0 1.54317,0.33752 1.98288,1.01267 l 0.42744,0.71655 0.42753,-0.71655 c 0.43961,-0.67515 1.10463,-1.01267 1.9828704,-1.01267 0.75893,0 1.37037,0.2668 1.83735,0.78727 0.45268,0.52046 0.67808,1.22395 0.67808,2.10922"/>
  </symbol>
</svg>

<footer class="footer">
  <div class="footer_inner wrap pale">
    <img src='https://idouba.com/icons/apple-touch-icon.png' class="icon icon_2 transparent" alt="浙ICP备18050493号-1 浙公网安备 33010802006262号">
    <p>Copyright&nbsp;<span class="year"></span>&nbsp;浙ICP备18050493号-1 浙公网安备 33010802006262号. All Rights Reserved</p><a class="to_top" href="#documentTop">
  <svg class="icon">
  <title>to-top</title>
  <use xlink:href="#to-top"></use>
</svg>

</a>

  </div>
</footer>

<script type="text/javascript" src="https://idouba.com/en/js/bundle.ff336aa3aa59d3b9ad38479bb59153d96581fbb501e8946475e657e5412e6b0ecfd0011520c158ce613db24190d23242c59813c62c23f9d902b693489bbdf52f.js" integrity="sha512-/zNqo6pZ07mtOEebtZFT2WWB&#43;7UB6JRkdeZX5UEuaw7P0AEVIMFYzmE9skGQ0jJCxZgTxiwj&#43;dkCtpNIm731Lw==" crossorigin="anonymous"></script>

  <script src="https://idouba.com/js/search.min.786102b9f5b14ee0b60197dc064e532809aec49bcc43fea72e5a513113f04b44a7241d6683d3993d5b7a48582f4986e0b9a28c72ebc48a2072c52aad8f40a2b3.js"></script>

  </body>
</html>
