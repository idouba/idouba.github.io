
<!DOCTYPE html>
<html
  lang="en"
  data-figures=""
  
    class="page"
  
  
  >
  <head>
<title>Istio 调用链埋点原理剖析—是否真的“零修改”？ | 爱豆吧！</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">





  
<meta property="og:locale" content="en" />

<meta property="og:type" content="article">
<meta name="description" content="发在Infoq上的一篇文章，答疑当前大家工作中碰到的Istio调用链的问题，最终澄清了观点，并推动社区修改了说法，避免误解。
前言 在 Istio 的实践中最近经常被问到一个问题，使用 Istio 做调用链用户的业务代码是不是完全 0 侵入，到底要不要修改业务代码？
看官方介绍：
Istio makes it easy …" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="">
<meta name="twitter:title" content="Istio 调用链埋点原理剖析—是否真的“零修改”？" />
<meta name="twitter:image" content="https://idouba.com/images/thumbnail.png"/>
<meta property="og:url" content="https://idouba.com/istio-tracing-is-not-zero-code-change/" />
<meta property="og:title" content="Istio 调用链埋点原理剖析—是否真的“零修改”？" />
<meta property="og:description" content="发在Infoq上的一篇文章，答疑当前大家工作中碰到的Istio调用链的问题，最终澄清了观点，并推动社区修改了说法，避免误解。
前言 在 Istio 的实践中最近经常被问到一个问题，使用 Istio 做调用链用户的业务代码是不是完全 0 侵入，到底要不要修改业务代码？
看官方介绍：
Istio makes it easy …" />
<meta property="og:image" content="https://idouba.com/images/thumbnail.png" />

<link rel="apple-touch-icon" sizes="180x180" href="https://idouba.com/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://idouba.com/icons/favicon-32x32.png">
<link rel="manifest" href="https://idouba.com/icons/site.webmanifest">

<link rel="canonical" href="https://idouba.com/istio-tracing-is-not-zero-code-change/">



<link rel="preload" href="https://idouba.com/css/styles.42e2c5f6d8cf9c52872666f8d8b2678ad0c426978b9d78aff3c33b7a1e7f6f97f54bcdaf0518a25fb0fe26367d04f8b07c683b3b38b331cb098daadee06b1f3e.css" integrity = "sha512-QuLF9tjPnFKHJmb42LJnitDEJpeLnXiv88M7eh5/b5f1S82vBRiiX7D&#43;JjZ9BPiwfGg7OzizMcsJjare4GsfPg==" as="style" crossorigin="anonymous">



<link rel="preload" href="https://idouba.com/en/js/bundle.ff336aa3aa59d3b9ad38479bb59153d96581fbb501e8946475e657e5412e6b0ecfd0011520c158ce613db24190d23242c59813c62c23f9d902b693489bbdf52f.js" as="script" integrity=
"sha512-/zNqo6pZ07mtOEebtZFT2WWB&#43;7UB6JRkdeZX5UEuaw7P0AEVIMFYzmE9skGQ0jJCxZgTxiwj&#43;dkCtpNIm731Lw==" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="https://idouba.com/css/styles.42e2c5f6d8cf9c52872666f8d8b2678ad0c426978b9d78aff3c33b7a1e7f6f97f54bcdaf0518a25fb0fe26367d04f8b07c683b3b38b331cb098daadee06b1f3e.css" integrity="sha512-QuLF9tjPnFKHJmb42LJnitDEJpeLnXiv88M7eh5/b5f1S82vBRiiX7D&#43;JjZ9BPiwfGg7OzizMcsJjare4GsfPg==" crossorigin="anonymous">

  </head>
  <body
    data-code="7"
    data-lines="false"
    id="documentTop"
    data-lang="en"
  >

<header class="nav_header" >
  <nav class="nav"><a href='https://idouba.com/' class="nav_brand nav_item" title="爱豆吧！">爱豆吧！
  <div class="nav_close">
    <div><svg class="icon">
  <title>open-menu</title>
  <use xlink:href="#open-menu"></use>
</svg>
<svg class="icon">
  <title>closeme</title>
  <use xlink:href="#closeme"></use>
</svg>
</div>
  </div>
</a>

    <div class='nav_body nav_body_left'>
      
      
      
        

  <div class="nav_parent">
    <a href="https://idouba.com/" class="nav_item" title="Home">Home </a>
  </div>
  <div class="nav_parent">
    <a href="https://idouba.com/post/rich-content/" class="nav_item" title="Archives">Archives </a>
  </div>
  <div class="nav_parent">
    <a href="https://idouba.com/about/" class="nav_item" title="About">About </a>
  </div>
      
      <div class="nav_parent">
        <a href="#" class="nav_item">🌐</a>
        <div class="nav_sub">
          <span class="nav_child"></span>
          
          <a href="https://idouba.com/" class="nav_child nav_item">English</a>
          
          <a href="https://idouba.com/pt/" class="nav_child nav_item">Português</a>
          
        </div>
      </div>
<div class='follow'>
<div class="color_mode">
  <input type="checkbox" class="color_choice" id="mode">
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class="grid-inverse wrap content">
  <article class="post_content">
    <h1 class="post_title">Istio 调用链埋点原理剖析—是否真的“零修改”？</h1>
  <div class="post_meta">
    <span><svg class="icon">
  <title>calendar</title>
  <use xlink:href="#calendar"></use>
</svg>
</span>
    <span class="post_date">
      Nov 29, 2018</span>
    <span class="post_time"> · 5 min read</span><span>&nbsp;· <a href='https://idouba.com/tags/istio/' title="Istio" class="post_tag button button_translucent">Istio
        </a><a href='https://idouba.com/tags/%E5%8F%91%E8%A1%A8/' title="发表" class="post_tag button button_translucent">发表
        </a><a href='https://idouba.com/tags/infoq/' title="Infoq" class="post_tag button button_translucent">Infoq
        </a>
    </span>
    <span class="page_only">&nbsp;·
  <div class="post_share">
    Share on:
    <a href="https://twitter.com/intent/tweet?text=Istio%20%e8%b0%83%e7%94%a8%e9%93%be%e5%9f%8b%e7%82%b9%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e2%80%94%e6%98%af%e5%90%a6%e7%9c%9f%e7%9a%84%e2%80%9c%e9%9b%b6%e4%bf%ae%e6%94%b9%e2%80%9d%ef%bc%9f&url=https%3a%2f%2fidouba.com%2fistio-tracing-is-not-zero-code-change%2f&tw_p=tweetbutton" class="twitter" title="Share on Twitter" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>twitter</title>
  <use xlink:href="#twitter"></use>
</svg>

    </a>
    <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fidouba.com%2fistio-tracing-is-not-zero-code-change%2f&t=Istio%20%e8%b0%83%e7%94%a8%e9%93%be%e5%9f%8b%e7%82%b9%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e2%80%94%e6%98%af%e5%90%a6%e7%9c%9f%e7%9a%84%e2%80%9c%e9%9b%b6%e4%bf%ae%e6%94%b9%e2%80%9d%ef%bc%9f" class="facebook" title="Share on Facebook" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>facebook</title>
  <use xlink:href="#facebook"></use>
</svg>

    </a>
    <a href="#linkedinshare" id = "linkedinshare" class="linkedin" title="Share on LinkedIn" rel="nofollow">
      <svg class="icon">
  <title>linkedin</title>
  <use xlink:href="#linkedin"></use>
</svg>

    </a>
    <a href="https://idouba.com/istio-tracing-is-not-zero-code-change/" title="Copy Link" class="link link_yank">
      <svg class="icon">
  <title>copy</title>
  <use xlink:href="#copy"></use>
</svg>

    </a>
  </div>
  </span>
  </div>

    <div class="post_body"><p>发在<a href="https://www.infoq.cn/article/pqy*PFPhox9OQQ9iCRTt">Infoq</a>上的一篇文章，答疑当前大家工作中碰到的Istio调用链的问题，最终澄清了观点，并推动社区修改了说法，避免误解。</p>
<h2 id="前言">前言</h2>
<p>在 Istio 的实践中最近经常被问到一个问题，使用 Istio 做调用链用户的业务代码是不是完全 0 侵入，到底要不要修改业务代码？</p>
<p>看官方介绍：</p>
<blockquote>
<p>Istio makes it easy to create a network of deployed services with load balancing, service-to-service authentication, monitoring, and more, <em>without any changes</em> in service code.</p>
</blockquote>
<p>是不用修改任何代码即可做各种治理。实际使用中应用程序不做任何修改，使用 Istio 的调用链输出总是断开的，这到底是什么原因呢？</p>
<p>对以上问题关注的人比较多，但是貌似说的都不是特别清楚，在最近的 K8S 技术社区的 Meetup 上笔者专门做了主题分享，通过解析 Istio 的架构机制与 Istio 中调用链的工作原理来回答以上问题。在本文中将节选里面的重点内容，基于 Istio 官方典型的示例来展开其中的每个细节和原理。</p>
<p>Istio 本身的内容在这里不多介绍，作为 Google 继 Kubernetes 之后的又一重要项目，Istio 提供了 Service Mesh 方式服务治理的完整的解决方案。正如其首页介绍，通过非侵入的方式提供了服务的连接、控制、保护和观测能力。包括智能控制服务间的流量和 API 调用；提供授权、认证和通信加密机制自动保护服务安全；通过开放策略来控制调用者对服务的访问；另外提供了可扩展丰富的调用链、监控、日志等手段来对服务与性能进行观测。即用户不用修改代码，就可以实现各种服务治理能力。</p>
<p>较之其他系统和平台，Istio 比较明显的一个特点是服务运行的监控数据都可以动态获取和输出，提供了强大的调用链、监控和调用日志收集输出的能力。配合可视化工具，运维人员可以方便的看到系统的运行状况，并发现问题进而解决问题。而我们基本上不用在自己的代码里做任何修改来生成数据并对接各种监控、日志、调用链等后端。非常神奇的是只要我们的程序被部署 run 起来，其运行数据就自动收集并在一个面板上展现出来。</p>
<h2 id="调用链概述">调用链概述</h2>
<p>对于分布式系统的运维管理和故障定位来说，调用链当然是第一利器。</p>
<p><figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt=""
      
        class="image_figure image_external image_processed"
        width="554"
        height="265"
        src="/images/7e04e3441cac058f374c1d2d345ec6b3_7613012983143861456.jpg"
      
      
    />

    </picture>
</figure>
</p>
<p>正如 Service Mesh 的诞生是为了解决大规模分布式服务访问的治理问题，调用链的出现也是为了对应于大规模的复杂的分布式系统运行中碰到的故障定位定界问题。大量的服务调用、跨进程、跨服务器，可能还会跨多个物理机房。无论是服务自身问题还是网络环境的问题导致调用上链路上出现问题都比较复杂，如何定位就比单进程的一个服务打印一个异常栈来找出某个方法要困难的多。需要有一个类似的调用链路的跟踪，经一次请求的逻辑规矩完整的表达出来，可以观察到每个阶段的调用关系，并能看到每个阶段的耗时和调用详细情况。</p>
<p><a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36356.pdf" target="_blank">Dapper, a Large-Scale Distributed Systems Tracing Infrastructure</a> 描述了其中的原理和一般性的机制。模型中包含的术语也很多，理解最主要的两个即可：</p>
<ul>
<li>Trace：一次完整的分布式调用跟踪链路。</li>
<li>Span：跨服务的一次调用； 多个 Span 组合成一次 Trace 追踪记录。</li>
</ul>
<p>上图是 Dapper 论文中的经典图示，左表示一个分布式调用关系。前端（A），两个中间层（B 和 C），以及两个后端（D 和 E）。用户发起一个请求时，先到达前端，再发送两个服务 B 和 C。B 直接应答，C 服务调用后端 D 和 E 交互之后给 A 应答，A 进而返回最终应答。要使用调用链跟踪，就是给每次调用添加 TraceId、SpanId 这样的跟踪标识和时间戳。</p>
<p>右表示对应 Span 的管理关系。每个节点是一个 Span，表示一个调用。至少包含 Span 的名、父 SpanId 和 SpanId。节点间的连线下表示 Span 和父 Span 的关系。所有的 Span 属于一个跟踪，共用一个 TraceId。从图上可以看到对前端 A 的调用 Span 的两个子 Span 分别是对 B 和 C 调用的 Span，D 和 E 两个后端服务调用的 Span 则都是 C 的子 Span。</p>
<p>调用链系统有很多实现，用的比较多的如<a href="https://zipkin.io/" target="_blank">zipkin</a>，还有已经加入 CNCF 基金会并且的用的越来越多的<a href="https://www.jaegertracing.io/" target="_blank">Jaeger</a>，满足 Opentracing 语义标准的就有<a href="http://opentracing.io/documentation/pages/supported-tracers.html" target="_blank">这么多</a>。</p>
<p><figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt=""
      
        class="image_figure image_external image_processed"
        width="1267"
        height="681"
        src="/images/e9a56816d4e7b3cfff3dc97624d33ed9_4784263072932632871.png"
      
      
    />

    </picture>
</figure>
</p>
<p>一个完整的调用链跟踪系统，包括调用链埋点，调用链数据收集，调用链数据存储和处理，调用链数据检索（除了提供检索的 APIServer，一般还要包含一个非常酷炫的调用链前端）等若干重要组件。如图是 Jaeger 的一个完整实现。</p>
<p>这里我们仅关注与应用相关的内容，即调用链埋点的部分，看下在 Istio 中是否能做到”无侵入“的调用链埋点。调用链的埋点是一个比起来记录日志，报个 metric 或者告警要复杂的多。根本原因其数据结构要相对复杂一些，为了能将在多个点上收集的关于一次调用的多个中间请求过程关联起来形成一个链。下面通过详析自带的典型例子来看下这里的细节。</p>
<h2 id="调用链示例">调用链示例</h2>
<p>简单起见，我们以 Istio 最经典的 Bookinfo 为例来说明。Bookinfo 模拟在线书店的一个分类，显示一本书的信息。本身是一个异构应用，几个服务分别由不同的语言编写的。各个服务的模拟作用和调用关系是：</p>
<ul>
<li>Productpage ：Productpage 服务会调用 Details 和 Reviews 两个服务，用来生成页面。</li>
<li>Details ：这个微服务包含了书籍的信息。</li>
<li>Reviews ：这个微服务包含了书籍相关的评论。并调用 Ratings 微服务。</li>
<li>Ratings ：Ratings 微服务中包含了由书籍评价组成的评级信息。</li>
</ul>
<p>在 Istio 上运行这个典型例子，不用做任何的代码修改，自带的 Zipkin 上就能看到如下的调用链输出。</p>
<p><figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt=""
      
        class="image_figure image_external image_processed"
        width="830"
        height="462"
        src="/images/5a76ec8e66cf61633ad1183ff6b935e9_17875463487676599201.png"
      
      
    />

    </picture>
</figure>
</p>
<p>可以看到 zipkin 上展示给我们的调用链和 Boookinfo 这个场景设计的调用关系一致：Productpage 服务会调用 Details 和 Reviews 两个服务，Reviews 调用了 Ratings 微服务。除了显示调用关系外，还显示了每个中间调用的耗时和调用详情。基于这个视图，服务的运维人员比较直观的定界到慢的或者有问题的服务，并钻取当时的调用细节，进而定位到问题。我们就要关注下调用链埋点到底是在哪里做的，怎么做的？</p>
<p><figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt=""
      
        class="image_figure image_external image_processed"
        width="851"
        height="366"
        src="/images/13e55c574948a341e676823fc0374351_17107004296496831768.png"
      
      
    />

    </picture>
</figure>
</p>
<h2 id="istio-调用链埋点逻辑">Istio 调用链埋点逻辑</h2>
<p>在 Istio 中，所有的治理逻辑的执行体都是和业务容器一起部署的 Envoy 这个 Sidecar，不管是负载均衡、熔断、流量路由还是安全、可观察性的数据生成都是在 Envoy 上。Sidecar 拦截了所有的流入和流出业务程序的流量，根据收到的规则执行执行各种动作。实际使用中一般是基于 K8S 提供的 InitContainer 机制，用于在 Pod 中执行一些初始化任务. InitContainer 中执行了一段 Iptables 的脚本。正是通过这些 Iptables 规则拦截 pod 中流量，并发送到 Envoy 上。Envoy 拦截到 Inbound 和 Outbound 的流量会分别作不同操作，执行上面配置的操作，另外再把请求往下发，对于 Outbound 就是根据服务发现找到对应的目标服务后端上；对于 Inbound 流量则直接发到本地的服务实例上。</p>
<p>所以我们的重点是看下拦截到流量后 Sidecar 在调用链埋点怎么做的。</p>
<p>Envoy 的埋点规则和在其他服务调用方和被调用方的对应埋点逻辑没有太大差别，甚至和一般 SDK 方式内置的调用链埋点逻辑也类似。</p>
<ul>
<li>Inbound 流量：对于经过 Sidecar 流入应用程序的流量，如果经过 Sidecar 时 Header 中没有任何跟踪相关的信息，则会在创建一个根 Span，TraceId 就是这个 SpanId，然后再将请求传递给业务容器的服务；如果请求中包含 Trace 相关的信息，则 Sidecar 从中提取 Trace 的上下文信息并发给应用程序。</li>
<li>Outbound 流量：对于经过 Sidecar 流出的流量，如果经过 Sidecar 时 Header 中没有任何跟踪相关的信息，则会创建根 Span，并将该跟 Span 相关上下文信息放在请求头中传递给下一个调用的服务；当存在 Trace 信息时，Sidecar 从 Header 中提取 Span 相关信息，并基于这个 Span 创建子 Span，并将新的 Span 信息加在请求头中传递。</li>
</ul>
<p>特别是 Outbound 部分的调用链埋点逻辑，通过一段伪代码描述如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">parentSpan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracer</span><span class="p">.</span><span class="na">getTracer</span><span class="p">().</span><span class="na">extract</span><span class="p">(</span><span class="n">headers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"> 	</span><span class="k">if</span><span class="p">(</span><span class="n">parentSpan</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"> 	</span><span class="n">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracer</span><span class="p">.</span><span class="na">buildSpan</span><span class="p">(</span><span class="n">operation</span><span class="p">).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"> 	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"> 	</span><span class="n">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracer</span><span class="p">.</span><span class="na">buildSpan</span><span class="p">(</span><span class="n">operation</span><span class="p">).</span><span class="na">asChildOf</span><span class="p">(</span><span class="n">parentSpan</span><span class="p">).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"> 	</span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>如图是对前面 Zipkin 上输出的一个 Trace 一个透视图，观察下每个调用的细节。可以看到每个阶段四个服务与部署在它旁边上的 Sidecar 是怎么配合的。在图上只标记了 Sidecar 生成的 Span 主要信息。下面基于具体的例子我们走一遍流程，类剖析下细节，最终得出我们关系的业务代码要做哪些事情？</p>
<p>因为 Sidecar 处理 Inbound 和 Outbound 的逻辑有所不同，在图上表也分开两个框图分开表达。如 Productpage，接收外部请求是一个处理，给 Details 发出请求是一个处理，给 Reviews 发出请求是另外一个处理，因此围绕 Productpage 这个 app 有三个黑色的处理块，其实是一个 Sidecar 在做事。</p>
<p>同时，为了不使的图上箭头太多，最终的 Response 都没有表达出来，其实图上每个请求的箭头都有一个反方向的 Response。在服务发起方的 Sidecar 会收到 Response 时，会记录一个 CR(client Received) 表示收到响应的时间并计算整个 Span 的持续时间。</p>
<p><figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt=""
      
        class="image_figure image_external image_processed"
        width="1752"
        height="645"
        src="/images/a041f85697f8ff38076e3d3856f3ad48_6870722201432683408.png"
      
      
    />

    </picture>
</figure>
</p>
<p>下面通过解析下具体数据来找出埋点逻辑：</p>
<ol>
<li>首先从调用入口的 Gateway 开始，Gateway 作为一个独立部署在一个 pod 中的 Envoy 进程，当有请求过来时，它会将请求转给入口服务 Productpage。Gateway 这个 Envoy 在发出请求时里面没有 Trace 信息，会生成一个根 Span：SpanId 和 TraceId 都是 f79a31352fe7cae9，因为是第一个调用链上的第一个 Span，也就是一般说的根 Span，所有 ParentId 为空，在这个时候会记录 CS（Client Send）；</li>
<li>请求从入口 Gateway 这个 Envoy 进入 Productpage 的 app 业务进程其 Inbound 流量被 Productpage Pod 内的 Envoy 拦截，Envoy 处理请求头中带着 Trace 信息，记录 SR(Server Received)，并将请求发送给 Productpage 业务容器处理，Productpage 在处理请求的业务方法中在接受调用的参数时，除了接受一般的业务参数外，同时解析请求中的调用链 Header 信息，并把 Header 中的 Trace 信息传递给了调用的 Details 和 Reviews 的微服务。</li>
<li>从 Productpage 出去的请求到达 Reviews 服务前，其 Oubtbound 流量又一次通过同 Pod 的 Envoy，Envoy 埋点逻辑检查 Header 中包含了 Trace 相关信息，在将请求发出前会做客户端的调用链埋点，即以当前 Span 为 parent Span，生成一个子 Span：新的 SpanId cb4c86fb667f3114，TraceId 保持一致 9a31352fe7cae9，ParentId 就是上个 Span 的 Id： f79a31352fe7cae9。</li>
<li>从 Productpage 到 Reviews 的请求经过 Productpage 的 Sidecar 走 LB 后，发给一个 Reviews 的实例。请求在到达 Reviews 业务容器前，同样也被 Reviews 的 Envoy 拦截，Envoy 检查从 Header 中解析出 Trace 信息存在，则发送 Trace 信息给 Reviews。Reviews 处理请求的服务端代码中同样接收和解析出这些包含 Trace 的 Header 信息，发送给下一个 Ratings 服务。</li>
</ol>
<p>在这里我们只是理了一遍请求从入口 Gateway，访问 Productpage 服务，再访问 Reviews 服务的流程。可以看到期间每个访问阶段，对服务的 Inbound 和 Outbound 流量都会被 Envoy 拦截并执行对应的调用链埋点逻辑。图示的 Reviews 访问 Ratings 和 Productpage 访问 Details 逻辑与以上类似，这里不做复述。</p>
<p>以上过程也印证了前面我们提出的 Envoy 的埋点逻辑。可以看到过程中除了 Envoy 处理 Inbound 和 Outbound 流量时要执行对应的埋点逻辑外，每一步的调用要串起来，应用程序其实做了些事情。就是在将请求发给下一个服务时，需要将调用链相关的信息同样传下去，尽管这些 Trace 和 Span 的标识并不是它生成的。这样在出流量的 Proxy 向下一跳服务发起请求前才能判断并生成子 Span 并和原 Span 进行关联，进而形成一个完整的调用链。否则，如果在应用容器未处理 Header 中的 Trace，则 Sidecar 在处理请求时会创建根 Span，最终会形成若干个割裂的 Span，并不能被关联到一个 Trace 上，就会出现我们开始提到的问题。</p>
<p>不断被问到两个问题来试图说明这个业务代码配合修改来实现调用链逻辑可能不必要：</p>
<p>问题一：既然传入的请求上已经带了这些 Header 信息了，直接往下一直传不就好了吗？Sidecar 请求 APP 的时候带着这些 Header，APP 请求 Sidecar 时也带着这些 Header 不就完了吗？</p>
<p>问题二：既然 TraceId 和 SpanId 是同一个 Sidecar 生成的，为什么要再费劲让 App 收到请求的时候解析下，发出请求时候再带着发出来传回给 Sidecar 呢？</p>
<p><figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt=""
      
        class="image_figure image_external image_processed"
        width="820"
        height="500"
        src="/images/9a339365844590c00f725642dc3a3e5e_10705501743841389576.png"
      
      
    />

    </picture>
</figure>
</p>
<p>回答问题一，只需理解一点，这里的 App 业务代码是处理请求不是转发请求，即图上左边的 Request to Productpage 到 Productpage 中请求就截止了，要怎么处理完全是 Productpage 的服务接口的内容了，可以是调用本地处理逻辑直接返回，也可以是如示例中的场景构造新的请求调用其他的服务。右边的 Request from Productpage 完全是 Productpage 服务构造的发出的另外一个请求。</p>
<p>回答问题二，需要理解当前 Envoy 是独立的 Listener 来处理 Inbound 和 Outbound 的请求。Inbound 只会处理入的流量并将流量转发到本地的服务实例上。而 Outbound 就是根据服务发现找到对应的目标服务后端上。除了在一个进程里外两个之间可以说没有任何关系。 另外如问题一描述，因为到 Outbound 已经是一个新构造的请求了，使得想维护一个 map 来记录这些 Trace 信息这种方案也变得不可行。</p>
<p>例子中 Productpage 访问 Reviews 的 Span 详细如下，删减掉一些数据只保留主要信息大致是这样：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="p">{</span> 
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">	<span class="nt">&#34;traceId&#34;</span><span class="p">:</span> <span class="s2">&#34;f79a31352fe7cae9&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">	 <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;cb4c86fb667f3114&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	 <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;reviews-route&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	 <span class="nt">&#34;parentId&#34;</span><span class="p">:</span> <span class="s2">&#34;f79a31352fe7cae9&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	 <span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="mi">1536132571847838</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	 <span class="nt">&#34;duration&#34;</span><span class="p">:</span> <span class="mi">64849</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	 <span class="nt">&#34;annotations&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="p">{</span> 
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">		<span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="mi">1536132571847838</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">		 <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;cs&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">		 <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="ln">12</span><span class="cl">			<span class="nt">&#34;serviceName&#34;</span><span class="p">:</span> <span class="s2">&#34;productpage&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">			 <span class="nt">&#34;ipv4&#34;</span><span class="p">:</span> <span class="s2">&#34;172.16.0.33&#34;</span> 
</span></span><span class="line"><span class="ln">14</span><span class="cl">		<span class="p">}</span> 
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="p">},</span>   <span class="p">{</span> 
</span></span><span class="line"><span class="ln">16</span><span class="cl">		<span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="mi">1536132571848121</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">		 <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;sr&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">		 <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="ln">19</span><span class="cl">			<span class="nt">&#34;serviceName&#34;</span><span class="p">:</span> <span class="s2">&#34;reviews&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">			 <span class="nt">&#34;ipv4&#34;</span><span class="p">:</span> <span class="s2">&#34;172.16.0.32&#34;</span> 
</span></span><span class="line"><span class="ln">21</span><span class="cl">		<span class="p">}</span> 
</span></span><span class="line"><span class="ln">22</span><span class="cl">	<span class="p">},</span>   <span class="p">{</span> 
</span></span><span class="line"><span class="ln">23</span><span class="cl">		<span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="mi">1536132571912403</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">		 <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;ss&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">		 <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="ln">26</span><span class="cl">			<span class="nt">&#34;serviceName&#34;</span><span class="p">:</span> <span class="s2">&#34;reviews&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">			 <span class="nt">&#34;ipv4&#34;</span><span class="p">:</span> <span class="s2">&#34;172.16.0.32&#34;</span> 
</span></span><span class="line"><span class="ln">28</span><span class="cl">		<span class="p">}</span> 
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="p">},</span>   <span class="p">{</span> 
</span></span><span class="line"><span class="ln">30</span><span class="cl">		<span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="mi">1536132571912687</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">		 <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;cr&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">		 <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="ln">33</span><span class="cl">			<span class="nt">&#34;serviceName&#34;</span><span class="p">:</span> <span class="s2">&#34;productpage&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">			 <span class="nt">&#34;ipv4&#34;</span><span class="p">:</span> <span class="s2">&#34;172.16.0.33&#34;</span> 
</span></span><span class="line"><span class="ln">35</span><span class="cl">		<span class="p">}</span> 
</span></span><span class="line"><span class="ln">36</span><span class="cl">	<span class="p">}</span> <span class="p">],</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">	 <span class="nt">&#34;binaryAnnotations&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="p">{</span> 
</span></span><span class="line"><span class="ln">38</span><span class="cl">		<span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;http.status_code&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">		 <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;200&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">		 <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="ln">41</span><span class="cl">			<span class="nt">&#34;serviceName&#34;</span><span class="p">:</span> <span class="s2">&#34;reviews&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">			 <span class="nt">&#34;ipv4&#34;</span><span class="p">:</span> <span class="s2">&#34;172.16.0.32&#34;</span> 
</span></span><span class="line"><span class="ln">43</span><span class="cl">		<span class="p">}</span> 
</span></span><span class="line"><span class="ln">44</span><span class="cl">	<span class="p">},</span>   <span class="p">{</span> 
</span></span><span class="line"><span class="ln">45</span><span class="cl">		<span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;http.url&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">		 <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;http://reviews:9080/reviews/0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">		 <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="ln">48</span><span class="cl">			<span class="nt">&#34;serviceName&#34;</span><span class="p">:</span> <span class="s2">&#34;productpage&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">			 <span class="nt">&#34;ipv4&#34;</span><span class="p">:</span> <span class="s2">&#34;172.16.0.33&#34;</span> 
</span></span><span class="line"><span class="ln">50</span><span class="cl">		<span class="p">}</span> 
</span></span><span class="line"><span class="ln">51</span><span class="cl">	<span class="p">},</span>   <span class="p">{</span> 
</span></span><span class="line"><span class="ln">52</span><span class="cl">		<span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;response_size&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">		 <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;375&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">		 <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="ln">55</span><span class="cl">			<span class="nt">&#34;serviceName&#34;</span><span class="p">:</span> <span class="s2">&#34;reviews&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">			 <span class="nt">&#34;ipv4&#34;</span><span class="p">:</span> <span class="s2">&#34;172.16.0.32&#34;</span> 
</span></span><span class="line"><span class="ln">57</span><span class="cl">		<span class="p">}</span> 
</span></span><span class="line"><span class="ln">58</span><span class="cl">	<span class="p">}</span> <span class="p">]</span> 
</span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Productpage 的 Proxy 上报了个 CS，CR, Reviews 的那个 Proxy 上报了个 SS，SR。分别表示 Productpage 作为 client 什么时候发出请求，什么时候最终收到请求，Reviews 的 Proxy 什么时候收到了客户端的请求，什么时候发出了 response。另外还包括这次访问的其他信息如 Response Code、Response Size 等。</p>
<h2 id="业务代码修改">业务代码修改</h2>
<p>根据前面的分析我们可以得到结论：埋点逻辑是在 Sidecar 代理中完成，应用程序不用处理复杂的埋点逻辑，但应用程序需要配合在请求头上传递生成的 Trace 相关信息。下面抽取服务代码来印证下结论，并看下业务代码到底是怎么修改的。</p>
<p>Python 写的 Productpage 在服务端处理请求时，先从 Request 中提取接收到的 Header。然后再构造请求调用 Details 获取服务接口，并将 Header 转发出去。</p>
<p>首先处理 Productpage 请问的 Restful 方法中从 Request 中提取 Trace 相关的 Header.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/productpage&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"> 	<span class="k">def</span> <span class="nf">front</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"> 	<span class="n">product_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># TODO: replace default value</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"> 	<span class="n">Headers</span> <span class="o">=</span> <span class="n">getForwardHeaders</span><span class="p">(</span><span class="n">Request</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"> 	<span class="err">…</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"> 	<span class="n">detailsStatus</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">getProductDetails</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"> 	<span class="n">reviewsStatus</span><span class="p">,</span> <span class="n">reviews</span> <span class="o">=</span> <span class="n">getProductReviews</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl"> 	<span class="k">return</span> <span class="err">…</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">def</span> <span class="nf">getForwardHeaders</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"> 	<span class="n">Headers</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"> 	<span class="n">incoming_Headers</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;x-request-id&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"> 	<span class="s1">&#39;x-b3-traceid&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"> 	<span class="s1">&#39;x-b3-spanId&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"> 	<span class="s1">&#39;x-b3-parentspanid&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"> 	<span class="s1">&#39;x-b3-sampled&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"> 	<span class="s1">&#39;x-b3-flags&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"> 	<span class="s1">&#39;x-ot-span-context&#39;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"> 	<span class="p">]</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"> 	<span class="k">for</span> <span class="n">ihdr</span> <span class="ow">in</span> <span class="n">incoming_Headers</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"> 	<span class="n">val</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ihdr</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"> 	<span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"> 	<span class="n">headers</span><span class="p">[</span><span class="n">ihdr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"> 	<span class="k">return</span> <span class="n">headers</span>
</span></span></code></pre></div><p> 	for ihdr in incoming_Headers:
 	val = request.headers.get(ihdr)
 	if val is not None:
 	headers[ihdr] = val
 	return headers</pre></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">def</span> <span class="nf">getProductReviews</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"> 	<span class="n">url</span> <span class="o">=</span> <span class="n">reviews</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span> <span class="o">+</span> <span class="n">reviews</span><span class="p">[</span><span class="s1">&#39;endpoint&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"> 	<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">Headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
</span></span></code></pre></div><p>Reviews 服务中 Java 的 Rest 代码类似，在服务端接收请求时，除了接收 Request 中的业务参数外，还要提取 Header 信息，调用 Ratings 服务时再传递下去。其他的 Productpage 调用 Details，Reviews 调用 ratings 逻辑类似。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@GET</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Path</span><span class="p">(</span><span class="s">&#34;/reviews/{productId}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="nf">bookReviewsById</span><span class="p">(</span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&#34;productId&#34;</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">productId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nd">@HeaderParam</span><span class="p">(</span><span class="s">&#34;end-user&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nd">@HeaderParam</span><span class="p">(</span><span class="s">&#34;x-request-id&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">xreq</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nd">@HeaderParam</span><span class="p">(</span><span class="s">&#34;x-b3-traceid&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">xTraceId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="nd">@HeaderParam</span><span class="p">(</span><span class="s">&#34;x-b3-spanid&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">xSpanId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nd">@HeaderParam</span><span class="p">(</span><span class="s">&#34;x-b3-parentspanid&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">xparentSpanId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nd">@HeaderParam</span><span class="p">(</span><span class="s">&#34;x-b3-sampled&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">xsampled</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nd">@HeaderParam</span><span class="p">(</span><span class="s">&#34;x-b3-flags&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">xflags</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="nd">@HeaderParam</span><span class="p">(</span><span class="s">&#34;x-ot-span-context&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">xotSpan</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>当然这里只是个 demo，示意下要在那个环节修改代码。实际项目中我们不会这样在每个业务方法上作这样的修改，这样对代码的侵入，甚至说污染太严重。根据语言的特点会尽力把这段逻辑提取成一段通用逻辑，只要能在接收和发送请求的地方能机械的 forward 这几个 Trace 相关的 Header 即可。如果需要更多的控制，如在在 Span 上加特定的 Tag，或者在应用代码中代码中对某个服务内部方法的调用进详细跟踪需要构造一个 Span，可以使用类似 opentracing 的对应方法来实现。</p>
<h2 id="社区声明">社区声明</h2>
<p>最近一直在和社区沟通，督促在更显著的位置明确的告诉使用者用 Istio 作治理并不是所有场景下都不需要修改代码，比如调用链，虽然用户不用业务代码埋点，但还是需要修改些代码。尤其是避免首页“without any change”对大家的误导。得到回应是 1.1 中社区首页 what-is-istio 已经修改了这部分说明，不再是 1.0 中说<a href="https://istio.io/docs/concepts/what-is-istio/#why-use-istio" target="_blank">without any changes in service code</a>，而是改为<a href="https://preliminary.istio.io/docs/concepts/what-is-istio/#why-use-istio" target="_blank">with few or no code changes in service code</a>。提示大家在使用 Isito 进行调用链埋点时，应用程序需要进行适当的修改。当然了解了其中原理，做起来也不会太麻烦。</p>
<p><figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt=""
      
        class="image_figure image_external image_processed"
        width="1092"
        height="168"
        src="/images/a498b31f5b985601b0975e687b27bd5c_16475733276816232113.png"
      
      
    />

    </picture>
</figure>
</p>
<p><figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt=""
      
        class="image_figure image_external image_processed"
        width="1086"
        height="170"
        src="/images/929ddad3dab29a3251c8502792cb05c8_8550841245353047406.png"
      
      
    />

    </picture>
</figure>
</p>
<p>改了个程度轻一点的否定词，很少几乎不用修改，还是基本不用改的意思。这也是社区一贯的观点。</p>
<p>结合对 Istio 调用链的原理的分析和一个典型例子中细节字段、流程包括代码的额解析，再加上和社区沟通的观点。得到以下结论：</p>
<ul>
<li>Istio 的绝大多数治理能力都是在 Sidecar 而非应用程序中实现，因此是非侵入的；</li>
<li>Istio 的调用链埋点逻辑也是在 Sidecar 代理中完成，对应用程序非侵入，但应用程序需做适当的修改，即配合在请求头上传递生成的 Trace 相关信息。</li>
</ul>
<p>文中内容比较多，有点啰嗦，原理性的东西不感兴趣也可以跳过，只要知道结论“Istio 调用链埋点业务代码要少量修改”就可以。</p>

    </div>
<div class="post_comments">
  
  
  
</div>




  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <br>
    
  
  <div class="search">
    <input type="search" class="search_field form_field" placeholder='Search...' id="find" autocomplete="off" data-scope='posts'>
    <label for="find" class="search_label"><svg class="icon">
  <title>search</title>
  <use xlink:href="#search"></use>
</svg>

    </label>
    
    <div class="search_results results"></div>
  </div>


    
    
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
      <li>
        <a href="https://idouba.com/detailed-parse-and-reproduce-istio-response-flags-index/" class="nav-link" title="基于实际案例解析Istio访问日志ResponseFlag系列">基于实际案例解析Istio访问日志ResponseFlag系列</a>
      </li>
      <li>
        <a href="https://idouba.com/detailed-parse-and-reproduce-istio-response-flags-14-RL/" class="nav-link" title="RL(服务限流)--Istio访问日志ResponseFlag重现与解析14">RL(服务限流)--Istio访问日志ResponseFlag重现与解析14</a>
      </li>
      <li>
        <a href="https://idouba.com/detailed-parse-and-reproduce-istio-response-flags-13-RL/" class="nav-link" title="RL(服务限流)--Istio访问日志ResponseFlag重现与解析13">RL(服务限流)--Istio访问日志ResponseFlag重现与解析13</a>
      </li>
      <li>
        <a href="https://idouba.com/detailed-parse-and-reproduce-istio-response-flags-12-UC/" class="nav-link" title="UC(上游连接中断)--Istio访问日志ResponseFlag重现与解析12">UC(上游连接中断)--Istio访问日志ResponseFlag重现与解析12</a>
      </li>
      <li>
        <a href="https://idouba.com/detailed-parse-and-reproduce-istio-response-flags-11-UT/" class="nav-link" title="UT(上游请求超时)--Istio访问日志ResponseFlag重现与解析11">UT(上游请求超时)--Istio访问日志ResponseFlag重现与解析11</a>
      </li>
      <li>
        <a href="https://idouba.com/detailed-parse-and-reproduce-istio-response-flags-10-FI/" class="nav-link" title="FI(注入错误故障)--Istio访问日志ResponseFlag重现与解析10">FI(注入错误故障)--Istio访问日志ResponseFlag重现与解析10</a>
      </li>
      <li>
        <a href="https://idouba.com/detailed-parse-and-reproduce-istio-response-flags-09-DI/" class="nav-link" title="DI(注入延时故障)--Istio访问日志ResponseFlag重现与解析09">DI(注入延时故障)--Istio访问日志ResponseFlag重现与解析09</a>
      </li>
      <li>
        <a href="https://idouba.com/detailed-parse-and-reproduce-istio-response-flags-08-NR/" class="nav-link" title="NR(没有匹配的路由)--Istio访问日志ResponseFlag重现与解析08">NR(没有匹配的路由)--Istio访问日志ResponseFlag重现与解析08</a>
      </li>
    </ul>
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">Categories</h2>
      <nav class="tags_nav">
        <a href='https://idouba.com/categories/istio/' class="post_tag button button_translucent" title="istio">
          ISTIO
          <span class="button_tally">29</span>
        </a>
        
        <a href='https://idouba.com/categories/%E9%9A%8F%E7%AC%94/' class="post_tag button button_translucent" title="随笔">
          随笔
          <span class="button_tally">14</span>
        </a>
        
        <a href='https://idouba.com/categories/hadoop/' class="post_tag button button_translucent" title="hadoop">
          HADOOP
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://idouba.com/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/' class="post_tag button button_translucent" title="数据库">
          数据库
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://idouba.com/categories/%E5%8F%91%E8%A1%A8/' class="post_tag button button_translucent" title="发表">
          发表
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://idouba.com/categories/golang/' class="post_tag button button_translucent" title="golang">
          GOLANG
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://idouba.com/categories/%E5%B9%B6%E5%8F%91/' class="post_tag button button_translucent" title="并发">
          并发
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://idouba.com/categories/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://idouba.com/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/' class="post_tag button button_translucent" title="机器学习">
          机器学习
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://idouba.com/categories/jvm/' class="post_tag button button_translucent" title="jvm">
          JVM
          <span class="button_tally">1</span>
        </a>
        
        
      </nav>
    </div>
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">Tags</h2>
      <nav class="tags_nav">
        <a href='https://idouba.com/tags/java/' class="post_tag button button_translucent" title="java">
          JAVA
          <span class="button_tally">17</span>
        </a>
        
        <a href='https://idouba.com/tags/kubecon/' class="post_tag button button_translucent" title="kubecon">
          KUBECON
          <span class="button_tally">16</span>
        </a>
        
        <a href='https://idouba.com/tags/%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97/' class="post_tag button button_translucent" title="访问日志">
          访问日志
          <span class="button_tally">16</span>
        </a>
        
        <a href='https://idouba.com/tags/responseflags/' class="post_tag button button_translucent" title="responseflags">
          RESPONSEFLAGS
          <span class="button_tally">15</span>
        </a>
        
        <a href='https://idouba.com/tags/istio/' class="post_tag button button_translucent" title="istio">
          ISTIO
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://idouba.com/tags/mapreduce/' class="post_tag button button_translucent" title="mapreduce">
          MAPREDUCE
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://idouba.com/tags/hadoop/' class="post_tag button button_translucent" title="hadoop">
          HADOOP
          <span class="button_tally">11</span>
        </a>
        
        <a href='https://idouba.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BCistio%E5%8E%9F%E7%90%86%E5%AE%9E%E8%B7%B5%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/' class="post_tag button button_translucent" title="云原生服务网格istio原理实践架构与源码解析">
          云原生服务网格ISTIO原理实践架构与源码解析
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://idouba.com/tags/%E6%BC%94%E8%AE%B2/' class="post_tag button button_translucent" title="演讲">
          演讲
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://idouba.com/tags/golang/' class="post_tag button button_translucent" title="golang">
          GOLANG
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://idouba.com/tags/doudou/' class="post_tag button button_translucent" title="doudou">
          DOUDOU
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://idouba.com/tags/infoq/' class="post_tag button button_translucent" title="infoq">
          INFOQ
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://idouba.com/tags/oracle/' class="post_tag button button_translucent" title="oracle">
          ORACLE
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://idouba.com/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/' class="post_tag button button_translucent" title="程序员">
          程序员
          <span class="button_tally">3</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Tags</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://idouba.com/tags/12306/' class=" post_tag button button_translucent" data-position=1 title="12306">12306<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/aqs/' class=" post_tag button button_translucent" data-position=1 title="aqs">AQS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/dc/' class=" post_tag button button_translucent" data-position=1 title="dc">DC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/di/' class=" post_tag button button_translucent" data-position=1 title="di">DI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/doudou/' class=" post_tag button button_translucent" data-position=3 title="doudou">DOUDOU<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/dpe/' class=" post_tag button button_translucent" data-position=1 title="dpe">DPE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/english/' class=" post_tag button button_translucent" data-position=1 title="english">ENGLISH<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/executor/' class=" post_tag button button_translucent" data-position=2 title="executor">EXECUTOR<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/fi/' class=" post_tag button button_translucent" data-position=1 title="fi">FI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/g20/' class=" post_tag button button_translucent" data-position=1 title="g20">G20<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/golang/' class=" post_tag button button_translucent" data-position=4 title="golang">GOLANG<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://idouba.com/tags/gre/' class=" post_tag button button_translucent" data-position=1 title="gre">GRE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/hadoop/' class=" post_tag button button_translucent" data-position=11 title="hadoop">HADOOP<span class="button_tally">11</span>
            </a>
            
            
            <a href='https://idouba.com/tags/infoq/' class=" post_tag button button_translucent" data-position=3 title="infoq">INFOQ<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/istio/' class=" post_tag button button_translucent" data-position=12 title="istio">ISTIO<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://idouba.com/tags/istiocon/' class=" post_tag button button_translucent" data-position=1 title="istiocon">ISTIOCON<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/istio%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/' class=" post_tag button button_translucent" data-position=1 title="istio权威指南">ISTIO权威指南<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/japanese/' class=" post_tag button button_translucent" data-position=1 title="japanese">JAPANESE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/java/' class=" post_tag button button_translucent" data-position=17 title="java">JAVA<span class="button_tally">17</span>
            </a>
            
            
            <a href='https://idouba.com/tags/jvm/' class=" post_tag button button_translucent" data-position=1 title="jvm">JVM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/k-medoids/' class=" post_tag button button_translucent" data-position=1 title="k-medoids">K-MEDOIDS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/kubecon/' class=" post_tag button button_translucent" data-position=16 title="kubecon">KUBECON<span class="button_tally">16</span>
            </a>
            
            
            <a href='https://idouba.com/tags/kubernetes/' class=" post_tag button button_translucent" data-position=2 title="kubernetes">KUBERNETES<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/mapreduce/' class=" post_tag button button_translucent" data-position=12 title="mapreduce">MAPREDUCE<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://idouba.com/tags/nc/' class=" post_tag button button_translucent" data-position=1 title="nc">NC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/nr/' class=" post_tag button button_translucent" data-position=1 title="nr">NR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/oracle/' class=" post_tag button button_translucent" data-position=3 title="oracle">ORACLE<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/pilot/' class=" post_tag button button_translucent" data-position=2 title="pilot">PILOT<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/responseflags/' class=" post_tag button button_translucent" data-position=15 title="responseflags">RESPONSEFLAGS<span class="button_tally">15</span>
            </a>
            
            
            <a href='https://idouba.com/tags/rl/' class=" post_tag button button_translucent" data-position=2 title="rl">RL<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/rpc/' class=" post_tag button button_translucent" data-position=1 title="rpc">RPC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/source/' class=" post_tag button button_translucent" data-position=2 title="source">SOURCE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/springcloud/' class=" post_tag button button_translucent" data-position=1 title="springcloud">SPRINGCLOUD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/uc/' class=" post_tag button button_translucent" data-position=1 title="uc">UC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/uf/' class=" post_tag button button_translucent" data-position=1 title="uf">UF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/uh/' class=" post_tag button button_translucent" data-position=1 title="uh">UH<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/upe/' class=" post_tag button button_translucent" data-position=1 title="upe">UPE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/urx/' class=" post_tag button button_translucent" data-position=1 title="urx">URX<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/ut/' class=" post_tag button button_translucent" data-position=1 title="ut">UT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E3%81%AB%E3%81%BB%E3%82%93%E3%81%94/' class=" post_tag button button_translucent" data-position=1 title="にほんご">にほんご<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E4%BA%8B%E5%8A%A1/' class=" post_tag button button_translucent" data-position=1 title="事务">事务<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BCistio%E5%8E%9F%E7%90%86%E5%AE%9E%E8%B7%B5%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/' class=" post_tag button button_translucent" data-position=6 title="云原生服务网格istio原理实践架构与源码解析">云原生服务网格ISTIO原理实践架构与源码解析<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E4%BF%A1/' class=" post_tag button button_translucent" data-position=2 title="信">信<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%85%B3%E4%BA%8E/' class=" post_tag button button_translucent" data-position=1 title="关于">关于<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%88%86%E7%B1%BB/' class=" post_tag button button_translucent" data-position=1 title="分类">分类<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%8F%91%E8%A1%A8/' class=" post_tag button button_translucent" data-position=1 title="发表">发表<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%9B%BD%E9%99%85%E7%B1%B3%E5%85%B0/' class=" post_tag button button_translucent" data-position=1 title="国际米兰">国际米兰<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%9B%BE%E4%B9%A6/' class=" post_tag button button_translucent" data-position=1 title="图书">图书<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/' class=" post_tag button button_translucent" data-position=1 title="垃圾回收">垃圾回收<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E5%B9%B6%E5%8F%91/' class=" post_tag button button_translucent" data-position=1 title="并发">并发<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/' class=" post_tag button button_translucent" data-position=1 title="执行计划">执行计划<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/' class=" post_tag button button_translucent" data-position=1 title="数据库">数据库<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/' class=" post_tag button button_translucent" data-position=2 title="服务网格">服务网格<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/' class=" post_tag button button_translucent" data-position=1 title="机器学习">机器学习<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E6%BC%94%E8%AE%B2/' class=" post_tag button button_translucent" data-position=6 title="演讲">演讲<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E7%A5%96%E6%AF%8D/' class=" post_tag button button_translucent" data-position=2 title="祖母">祖母<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/' class=" post_tag button button_translucent" data-position=3 title="程序员">程序员<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E7%B4%A2%E5%BC%95/' class=" post_tag button button_translucent" data-position=3 title="索引">索引<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%81%9A%E7%B1%BB/' class=" post_tag button button_translucent" data-position=1 title="聚类">聚类<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%A1%A8%E8%BF%9E%E6%8E%A5/' class=" post_tag button button_translucent" data-position=1 title="表连接">表连接<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%A5%BF%E5%AE%89/' class=" post_tag button button_translucent" data-position=1 title="西安">西安<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97/' class=" post_tag button button_translucent" data-position=16 title="访问日志">访问日志<span class="button_tally">16</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%B0%83%E7%94%A8%E9%93%BE/' class=" post_tag button button_translucent" data-position=2 title="调用链">调用链<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E8%B6%B3%E7%90%83/' class=" post_tag button button_translucent" data-position=1 title="足球">足球<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://idouba.com/tags/%E9%9A%8F%E7%AC%94/' class=" post_tag button button_translucent" data-position=3 title="随笔">随笔<span class="button_tally">3</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
  </section>
</aside>

  
</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab">
    <path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6 0L12.3 74.8z" />
    <path d="M12.3 74.7L.5 111c-1 3.2 0 6.8 3 8.8l101.6 74-92.5-119z"/>
    <path d="M105 193.7l-38.6-119h-54l92.7 119z"/>
    <path d="M105 193.7l38.7-119H66.4l38.7 119z"/>
    <path d="M105 193.7l38.7-119H198l-93 119z"/>
    <path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/>
    <path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6 0L198 74.8z"/>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M23 2.75A2.75 2.75 0 0 0 20.25 0H8.75A2.75 2.75 0 0 0 6 2.75v13.5A2.75 2.75 0 0 0 8.75 19h11.5A2.75 2.75 0 0 0 23 16.25zM18.25 14.5h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5z"></path>
    <path d="M8.75 20.5a4.255 4.255 0 0 1-4.25-4.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752 0 0 0 1 5.25v16A2.752 2.752 0 0 0 3.75 24h12a2.752 2.752 0 0 0 2.75-2.75v-.75z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram">
    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id=youtube>
    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow">
    <path d="M21 27v-8h3v11H0V19h3v8h18z"></path><path d="M17.1.2L15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8l13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing">
    <path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord">
    <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 18" id="mastodon">
    <path
    fill="#ffffff"
    d="m 15.054695,9.8859583 c -0.22611,1.1632697 -2.02517,2.4363497 -4.09138,2.6830797 -1.0774504,0.12856 -2.1382704,0.24673 -3.2694704,0.19484 -1.84996,-0.0848 -3.30971,-0.44157 -3.30971,-0.44157 0,0.1801 0.0111,0.35157 0.0333,0.51194 0.24051,1.82571 1.81034,1.93508 3.29737,1.98607 1.50088,0.0514 2.8373104,-0.37004 2.8373104,-0.37004 l 0.0617,1.35686 c 0,0 -1.0498104,0.56374 -2.9199404,0.66742 -1.03124,0.0567 -2.3117,-0.0259 -3.80308,-0.42069 -3.23454998,-0.85613 -3.79081998,-4.304 -3.87592998,-7.8024197 -0.026,-1.03871 -0.01,-2.01815 -0.01,-2.83732 0,-3.57732 2.34385998,-4.62587996 2.34385998,-4.62587996 1.18184,-0.54277 3.20976,-0.77101 5.318,-0.7882499985409 h 0.0518 C 9.8267646,0.01719834 11.856025,0.24547834 13.037775,0.78824834 c 0,0 2.34377,1.04855996 2.34377,4.62587996 0,0 0.0294,2.63937 -0.32687,4.47183"/>
 <path
    fill="#000000"
    d="m 12.616925,5.6916583 v 4.3315297 h -1.71607 V 5.8189683 c 0,-0.88624 -0.37289,-1.33607 -1.1187604,-1.33607 -0.82467,0 -1.23799,0.53361 -1.23799,1.58875 v 2.30122 h -1.70594 v -2.30122 c 0,-1.05514 -0.4134,-1.58875 -1.23808,-1.58875 -0.74587,0 -1.11876,0.44983 -1.11876,1.33607 v 4.2042197 h -1.71607 V 5.6916583 c 0,-0.88527 0.22541,-1.58876 0.67817,-2.10922 0.46689,-0.52047 1.07833,-0.78727 1.83735,-0.78727 0.87816,0 1.54317,0.33752 1.98288,1.01267 l 0.42744,0.71655 0.42753,-0.71655 c 0.43961,-0.67515 1.10463,-1.01267 1.9828704,-1.01267 0.75893,0 1.37037,0.2668 1.83735,0.78727 0.45268,0.52046 0.67808,1.22395 0.67808,2.10922"/>
  </symbol>
</svg>

<footer class="footer">
  <div class="footer_inner wrap pale">
    <img src='https://idouba.com/icons/apple-touch-icon.png' class="icon icon_2 transparent" alt="浙ICP备18050493号-1 浙公网安备 33010802006262号">
    <p>Copyright&nbsp;<span class="year"></span>&nbsp;浙ICP备18050493号-1 浙公网安备 33010802006262号. All Rights Reserved</p><a class="to_top" href="#documentTop">
  <svg class="icon">
  <title>to-top</title>
  <use xlink:href="#to-top"></use>
</svg>

</a>

  </div>
</footer>

<script type="text/javascript" src="https://idouba.com/en/js/bundle.ff336aa3aa59d3b9ad38479bb59153d96581fbb501e8946475e657e5412e6b0ecfd0011520c158ce613db24190d23242c59813c62c23f9d902b693489bbdf52f.js" integrity="sha512-/zNqo6pZ07mtOEebtZFT2WWB&#43;7UB6JRkdeZX5UEuaw7P0AEVIMFYzmE9skGQ0jJCxZgTxiwj&#43;dkCtpNIm731Lw==" crossorigin="anonymous"></script>

  <script src="https://idouba.com/js/search.min.786102b9f5b14ee0b60197dc064e532809aec49bcc43fea72e5a513113f04b44a7241d6683d3993d5b7a48582f4986e0b9a28c72ebc48a2072c52aad8f40a2b3.js"></script>

  </body>
</html>
